<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Coal Blending Ratio — light theme</title>
    <style>
/* =========================
   Variables css styles are here
   ========================= */
:root{
  --bg: #F7F8FA;
  --card: #FFFFFF;
  --muted: #6b7280;
  --text: #111827;
  --accent: #b71c1c;    /* red colour */
  --green: #16a34a;
  --border: #E5E7EB;
  --input-border: #D1D5DB;
  --accent-btn: #0f4db2;
  --color-blue-800: oklch(.424 .199 265.638);
}

/* =========================
   Base / layout
   ========================= */
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  /* final padding preserved from your file */
  padding: 80px 6px 6px;
  /* Note: this prevents page scrolling; remove if content gets clipped */
  overflow: hidden;
}

h1 {
  color: var(--text);
  margin: 8px 0;
  font-size: 1.3rem;
  text-align: left;
}

/* =========================
   Navbar & header controls
   ========================= */
.navbar {
  width: 100%;
  background-color: #f7f8fa;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 20px;
  color: white;
  position: fixed;
  top: 0;
  left: 0;
  height: 65px;
  z-index: 1000;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}
.navbar img { height: 95px; margin-right: 10px; margin-left: 0; }
.navbar h1 { margin-left: 0; font-size: 20px; color: black; }
.nav-buttons { display: flex; gap: 10px; margin-right: 20px; }
.navbar button {
  padding: 10px 15px;
  background-color: #02008a;
  color: #fff;
  border: none;
  cursor: pointer;
  border-radius: 5px;
  margin-right: 20px;
  font-weight: bold;
}
.navbar button:hover { background-color: #001cbb; }
.navbar .logout-btn {
  padding: 10px 16px;
  background-color: red !important;
  color: #fff !important;
  border: none;
  cursor: pointer;
  border-radius: 25px;
  font-weight: bold;
  transition: all 0.3s ease;
}
.navbar .logout-btn:hover { background-color: darkred !important; }

/* =========================
   Buttons & small controls
   ========================= */
.upload-btn {
  display: inline-block;
  background: #02008a;
  color: #fff;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
  margin: 6px 3px;
  border: none;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  font-size: 0.85rem;
}

/* small circular icon button (download PDF, etc.) */
.icon-btn {
  background: #02008a;
  color: #fff;
  border: none;
  padding: 12px;
  border-radius: 50%;
  font-size: 18px;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
  box-shadow: 0 4px 10px rgba(0,0,0,0.12);
}
/* Tooltip for icon-btn */
.icon-btn::after {
  content: attr(title);
  position: absolute;
  bottom: -35px;
  left: 50%;
  transform: translateX(-50%);
  background: #000;
  color: #fff;
  font-size: 12px;
  padding: 5px 8px;
  border-radius: 6px;
  opacity: 0;
  white-space: nowrap;
  pointer-events: none;
  transition: opacity 0.3s ease;
}
.icon-btn:hover::after { opacity: 1; }

/* fixed download button */
#downloadPDF {
  position: fixed;
  top: 100px;
  right: 20px;
  background: #02008a;
  color: #fff;
  border: none;
  padding: 10px 18px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
  transition: all 0.3s ease;
  z-index: 9999;
}
#downloadPDF:hover {
  background: #1e40af;
  transform: translateY(-2px);
  box-shadow: 0 6px 14px rgba(0,0,0,0.2);
}

/* loader */
#loader { display: none; color: var(--muted); margin-top: 4px; font-size: 0.8rem; }

/* =========================
   Grid / main layout
   ========================= */
.main-container {
  display: flex;
  flex-direction: column;
  gap: 14px;
  max-width: 900px;
  align-items: flex-start;
  flex: 1; /* keep final intent (take remaining width) */
}

/* mills grid */
.mills-grid {
  display: grid;
  grid-template-columns: 140px repeat(8, 1fr);
  gap: 4px;            /* preserved final smaller gap */
  margin: 8px 0;
  align-items: center;
  font-size: 0.72rem;  /* preserved final smaller font */
  width: 100%;
}

/* cell styling */
.mill {
  background: var(--card);
  border: 1px solid var(--border);
  text-align: center;
  padding: 4px;
  color: var(--text);
  min-height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 1px 2px rgba(16,24,40,0.03);
  border-radius: 6px;
  font-size: 0.72rem;
}

/* header states */
.mill.red {
  background: var(--accent);
  color: #fff;
  font-weight: 700;
  border: 1px solid rgba(0,0,0,0.08);
}
.mill.green {
  background: var(--green);
  color: #fff;
  font-weight: 700;
  border: 1px solid rgba(0,0,0,0.06);
}

/* special headers */
.mill.coal-flow,
.mill.gcv,
.mill.aft-head,
.mill.cost-head { background: #02008a; color: #fff; font-weight: 600; }

/* Inputs / selects */
.dropdown {
  width: 105%;
  padding: 4px;
  background: #fff;
  color: var(--text);
  border: 1px solid var(--input-border);
  border-radius: 4px;
  box-sizing: border-box;
  font-size: 0.6rem; /* preserved the final (smaller) dropdown font */
}

.percentage-input,
.flow-input,
.cost-input,
.generation-input {
  width: 88%;
  padding: 4px;
  background: #fff;
  border: 1px solid var(--input-border);
  color: var(--text);
  text-align: center;
  border-radius: 4px;
  box-sizing: border-box;
  outline: none;
  font-size: 0.72rem;
}

/* borders from your file (preserved) */
.percentage-input { border: 2px solid #02008a; }
.flow-input       { border: 2px solid #F1C40F; }
.generation-input { border: 2px solid #F1C40F; }
.cost-input       { border: 2px solid #F1C40F; background: #fff; }

.percentage-input::placeholder,
.flow-input::placeholder,
.cost-input::placeholder { color: var(--muted); }

.gcv-box {
  width: 92%;
  padding: 6px;
  text-align: center;
  font-weight: 700;
  background: #F3F4F6;
  border: 1px solid var(--input-border);
  color: var(--text);
  border-radius: 4px;
  box-sizing: border-box;
  font-size: 0.8rem;
}

/* aft cell */
.aft { min-height: 28px; color: var(--text); }

/* =========================
   Diagram / bunker visuals
   ========================= */
.layout { position: relative; transform-origin: top left; }

/* bunker grid */
.bunkers-grid {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 18px;
  align-items: end;
}

.bunker {
  width: 100%;
  max-width: 120px;
  height: 160px;
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.bunker svg { width: 100%; height: 120px; }
.bunker path { fill: none; stroke: black; stroke-width: 2; }

.label { text-align: center; margin-top: -6px; font-weight: bold; }

/* diagram (top line + arrows) when inside .layout (overview diagram row) */
.layout .top-line {
  position: absolute;
  top: 0;
  left: -10px;         /* start a bit earlier than first arrow */
  width: 520px;        /* adjusted to span above all bunkers */
  height: 2px;
  background: black;
}

.layout .top-lines {
  position: absolute;
  top: 0;
  left: -10px;         /* start a bit earlier than first arrow */
  width: 50px;        /* adjusted to span above all bunkers */
  height: 2px;
  background: black;
}
.layout .arrow {
  position: absolute;
  width: 2px;
  background: black;
}
.layout .arrow::after {
  content: '';
  position: absolute;
  left: -6px;
  bottom: 0;
  border-left: 7px solid transparent;
  border-right: 7px solid transparent;
  border-top: 10px solid black;
}

/* the container inside the grid so diagram aligns with columns 2..7 */
.diagram-in-grid { grid-column: 2 / 8; padding: 6px; }

/* =========================
   Single-bunker (the standalone view) - keeps final values from file
   ========================= */
.single-bunker-wrapper {
  position: relative;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  width: 100%;
  /* final vertical spacing preserved (you had two values; final one kept) */
  padding-top: 236px;
  height: 100%;
}

/* single-bunker specific top-line + arrow so it doesn't collide with .layout rules */
.single-bunker-wrapper .top-line {
  position: absolute;
  top: 108px;
  left: 50%;
  transform: translateX(-50%);
  width: 40px;
  height: 2px;
  background: #000;
  z-index: 10;
}
.single-bunker-wrapper .arrow {
  position: absolute;
  top: 110px;
  left: 50%;
  transform: translateX(-50%);
  width: 2px;
  height: 64px;
  background: #000;
  z-index: 11;
}
.single-bunker-wrapper .arrow::after {
  content: '';
  position: absolute;
  left: -7px;
  top: 100%;
  border-left: 7px solid transparent;
  border-right: 7px solid transparent;
  border-top: 10px solid #000;
}

/* enlarge bunker in single view (kept final transform) */
.single-bunker-wrapper .bunker { transform: scale(1.8); transform-origin: center; }

/* =========================
   Summary table (kept final - fixed to right)
   ========================= */
.summary-table {
  position: fixed;
  top: 160px;
  right: 20px;
  width: 220px;
  display: grid;
  grid-template-columns: 110px 1fr;
  gap: 6px;
  font-size: 0.8rem;
  background: white;
  padding: 8px;
  border-radius: 8px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.1);
}
.summary-cell {
  background: var(--card);
  border: 1px solid var(--border);
  padding: 8px;
  color: var(--text);
  text-align: center;
  border-radius: 6px;
}
.summary-cell.summary-header { background: #02008a; font-weight: 700; color: #fff; }

/* =========================
   Tabs / sidebar
   ========================= */
.tab-btn {
  width: 100%;
  background: #02008a;
  border: none;
  color: #fff;
  font-weight: 600;
  padding: 10px 0;
  font-size: 0.9rem;
  margin-bottom: 10px;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.22s, box-shadow 0.22s;
  box-shadow: 0 2px 8px rgba(67,108,194,0.05);
  outline: none;
}
.tab-btn.active {
  background: linear-gradient(90deg, #00bcd4 8%, #2442ba 92%);
  color: #fff;
  box-shadow: 0 4px 14px rgba(0,188,212,0.22);
}
.tab-panel { display: none; }
.tab-panel.active { display: block; }

/* sidebar sizing (kept your reduced value) */
#tabSidebar { min-width: 160px; max-width: 160px; padding: 16px 8px; }

#bunker1Tab[style*="display: block"] {
  display: flex !important;
  justify-content: flex-start;   /* start from left */
  align-items: flex-start;       /* start from top */
  min-height: 80vh;
  position: relative;            /* allow positioning inside */
}

#bunker1Tab[style*="display: block"] .main-container {
  transform: scale(1.2);
  transform-origin: top left;    /* scaling starts from top-left */
  position: absolute;            /* now you can control with top/left/right */
  top: -10px;                     /* adjust top gap */
  left: 120px;                    /* adjust left gap */
  /* or use right: 50px; if you want to push from right */
}

#bunker2Tab[style*="display: block"] {
  display: flex !important;
  justify-content: flex-start;   /* start from left */
  align-items: flex-start;       /* start from top */
  min-height: 80vh;
  position: relative;            /* allow positioning inside */
}

#bunker2Tab[style*="display: block"] .main-container {
  transform: scale(1.2);
  transform-origin: top left;    /* scaling starts from top-left */
  position: absolute;            /* now you can control with top/left/right */
  top: -10px;                     /* adjust top gap */
  left: 380px;                    /* adjust left gap */
  /* or use right: 50px; if you want to push from right */
}

#bunker3Tab[style*="display: block"] {
  display: flex !important;
  justify-content: flex-start;   /* start from left */
  align-items: flex-start;       /* start from top */
  min-height: 80vh;
  position: relative;            /* allow positioning inside */
}

#bunker3Tab[style*="display: block"] .main-container {
  transform: scale(1.2);
  transform-origin: top left;    /* scaling starts from top-left */
  position: absolute;            /* now you can control with top/left/right */
  top: -10px;                     /* adjust top gap */
  left: 380px;                    /* adjust left gap */
  /* or use right: 50px; if you want to push from right */
}
/* Layout only for bunker tabs */
.tab-panel .bunker-layout .diagram-container {
  width: 100%;
  display: flex;
  justify-content: flex-end;   /* push to right */
  align-items: flex-start;     /* move upwards */
  transform: scale(4);
  transform-origin: top right; /* scaling from top-right corner */
  position: relative;          /* enable top/right shifting */
  top: -250px;                  /* adjust vertical position */
  right: -1800px;                /* adjust horizontal position */
}

.diagram-container, .bunker svg {
  pointer-events: none;
}




/* =========================
   Responsive adjustments
   ========================= */
@media (max-width: 900px) {
  body { padding: 80px 6px 6px; } /* preserved */
  .main-container { max-width: 100%; }
  .mills-grid {
    grid-template-columns: 1fr; /* stack columns vertically */
    gap: 6px;
    font-size: 0.72rem;
  }
  .mill { width: 100%; min-height: 28px; font-size: 0.72rem; padding: 4px; }
  .dropdown,
  .percentage-input,
  .flow-input,
  .cost-input,
  .gcv-box,
  .generation-input {
    width: 100%; font-size: 0.72rem; padding: 4px;
  }
  /* diagram -> full width */
  .diagram-in-grid { grid-column: 1 / -1; }
  .diagram-in-grid .layout { transform: scale(0.9); }
  .diagram-row { flex-direction: column; gap: 12px; }
  .diagram-row .layout { transform: scale(0.7); width: 100%; }
  .diagram-row .summary-table { width: 100%; position: static; }
  .layout .top-line { width: 100%; left: 0; }
  /* center arrows in small screens */
  .layout .arrow, .arrow { left: auto !important; margin-left: calc(50% - 1px); }
  #downloadPDF { top: auto; bottom: 20px; right: 10px; }
  .navbar img { height: 60px; }
  .navbar h1 { font-size: 16px; }
  .nav-buttons { flex-direction: column; gap: 6px; margin-right: 0; }
}
</style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

</head>
<body>
 <div class="navbar">
    <img src="/images/abhitech-logo.png" alt="Company Logo">
    <h1>COAL BLENDING RATIO</h1>
    <div class="nav-buttons">
      <button onclick="window.location.href='slagging_coal_page.html'">Calculation</button>
      <button onclick="window.location.href='coal_table.html'">Coal Properties</button>
      <button onclick="window.location.href='model.html'">Model</button>
      <button class="logout-btn" onclick="logoutUser()">Logout</button>

      
    </div>
  </div>
  <div style="margin-top:8px;">
    <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" style="display:none" />
    <label for="excelFile" class="upload-btn">Upload Excel</label>
  </div>

  <div id="loader">Loading... please wait</div>
<button id="downloadPDF" class="icon-btn" title="Download page as PDF">⬇️</button>

<!-- Tabs Sidebar and Main Content -->
<div style="display: flex; width: 100%; align-items: flex-start; margin-top: 32px;">
  <!-- Sidebar (Tabs) -->
  <div id="tabSidebar" style="min-width: 210px; background: #fff; border-radius: 12px; margin-right: 24px; padding: 22px 12px; box-shadow: 0 3px 16px rgba(23,32,41,0.06);">
    <div style="font-weight: bold; font-size: 1.1rem; color: #02008a; margin-bottom: 34px; text-align: center;">Select Section</div>
    <button class="tab-btn" data-tab="overview">Overview</button>
    <button class="tab-btn" data-tab="bunker1">Bunker 1</button>
    <button class="tab-btn" data-tab="bunker2">Bunker 2</button>
    <button class="tab-btn" data-tab="bunker3">Bunker 3</button>
    <button class="tab-btn" data-tab="bunker4">Bunker 4</button>
    <button class="tab-btn" data-tab="bunker5">Bunker 5</button>
    <button class="tab-btn" data-tab="bunker6">Bunker 6</button>
  </div>

  <!-- Main Tab Content -->
  <div id="tabContent" style="flex: 1; background: #fff; border-radius: 13px; box-shadow: 0 1px 8px rgba(34,53,65,0.10); padding: 28px; min-height: 680px;">

    <!-- Overview Panel -->
    <div id="overviewTab" class="tab-panel" style="display:none;">
      <div class="overview-wrapper"></div>

      <div class="main-container">
        <div class="mills-grid" id="millsGrid">
          <!-- header row -->
          <div></div>
          <!-- changed headers to BUNKER 1..6 -->
          <div class="mill green">BUNKER 1</div>
          <div class="mill green">BUNKER 2</div>
          <div class="mill green">BUNKER 3</div>
          <div class="mill green">BUNKER 4</div>
          <div class="mill green">BUNKER 5</div>
          <div class="mill green">BUNKER 6</div>
          <div class="mill gcv">GCV(Kcal/kg)</div>
          <div class="mill cost-head">Cost/MT</div>

          <!-- Row 1: Coal selection 1 (first cell = dropdown, columns 2-7 = % under mills) -->
          <div class="mill"><select class="dropdown" id="coalDrop1"></select></div>
          <div class="mill"><input type="text" class="percentage-input" data-row="1" data-mill="0" placeholder="%"></div>
          <div class="mill"><input type="text" class="percentage-input" data-row="1" data-mill="1" placeholder="%"></div>
          <div class="mill"><input type="text" class="percentage-input" data-row="1" data-mill="2" placeholder="%"></div>
          <div class="mill"><input type="text" class="percentage-input" data-row="1" data-mill="3" placeholder="%"></div>
          <div class="mill"><input type="text" class="percentage-input" data-row="1" data-mill="4" placeholder="%"></div>
          <div class="mill"><input type="text" class="percentage-input" data-row="1" data-mill="5" placeholder="%"></div>
          <div class="mill"><div id="gcvBox1" class="gcv-box">--</div></div>
          <div class="mill"><input type="text" id="costBox1" class="cost-input" placeholder="Cost/MT"></div>

          <!-- Row 2: Coal selection 2 -->
          <div class="mill"><select class="dropdown" id="coalDrop2"></select></div>
          <div class="mill"><input type="text" class="percentage-input" data-row="2" data-mill="0" placeholder="%"></div>
          <div class="mill"><input type="text" class="percentage-input" data-row="2" data-mill="1" placeholder="%"></div>
          <div class="mill"><input type="text" class="percentage-input" data-row="2" data-mill="2" placeholder="%"></div>
          <div class="mill"><input type="text" class="percentage-input" data-row="2" data-mill="3" placeholder="%"></div>
          <div class="mill"><input type="text" class="percentage-input" data-row="2" data-mill="4" placeholder="%"></div>
          <div class="mill"><input type="text" class="percentage-input" data-row="2" data-mill="5" placeholder="%"></div>
          <div class="mill"><div id="gcvBox2" class="gcv-box">--</div></div>
          <div class="mill"><input type="text" id="costBox2" class="cost-input" placeholder="Cost/MT"></div>

          <!-- Row 3: Coal selection 3 -->
          <div class="mill"><select class="dropdown" id="coalDrop3"></select></div>
          <div class="mill"><input type="text" class="percentage-input" data-row="3" data-mill="0" placeholder="%"></div>
          <div class="mill"><input type="text" class="percentage-input" data-row="3" data-mill="1" placeholder="%"></div>
          <div class="mill"><input type="text" class="percentage-input" data-row="3" data-mill="2" placeholder="%"></div>
          <div class="mill"><input type="text" class="percentage-input" data-row="3" data-mill="3" placeholder="%"></div>
          <div class="mill"><input type="text" class="percentage-input" data-row="3" data-mill="4" placeholder="%"></div>
          <div class="mill"><input type="text" class="percentage-input" data-row="3" data-mill="5" placeholder="%"></div>
          <div class="mill"><div id="gcvBox3" class="gcv-box">--</div></div>
          <div class="mill"><input type="text" id="costBox3" class="cost-input" placeholder="Cost/MT"></div>

          <!-- NEW: Diagram row placed inside the grid so it aligns with Bunker 1..6 columns -->
          <div></div>
          <div class="diagram-in-grid" style="padding:8px;">
            <div class="layout">
              <div class="top-line"></div>
              <div class="arrow" style="height:60px; left:40px;"></div>
              <div class="arrow" style="height:60px; left:130px;"></div>
              <div class="arrow" style="height:60px; left:230px;"></div>
              <div class="arrow" style="height:60px; left:320px;"></div>
              <div class="arrow" style="height:60px; left:415px;"></div>
              <div class="arrow" style="height:60px; left:510px;"></div>

              <div class="bunkers-grid">
                <div class="bunker">
                  <svg viewBox="0 0 100 150" preserveAspectRatio="xMidYMid meet">
                    <path d="M10 10 V100 L45 140 M55 140 L90 100 V10" />
                  </svg>
                  <div class="label">Bunker 1</div>
                </div>
                <div class="bunker">
                  <svg viewBox="0 0 100 150" preserveAspectRatio="xMidYMid meet">
                    <path d="M10 10 V100 L45 140 M55 140 L90 100 V10" />
                  </svg>
                  <div class="label">Bunker 2</div>
                </div>
                <div class="bunker">
                  <svg viewBox="0 0 100 150" preserveAspectRatio="xMidYMid meet">
                    <path d="M10 10 V100 L45 140 M55 140 L90 100 V10" />
                  </svg>
                  <div class="label">Bunker 3</div>
                </div>
                <div class="bunker">
                  <svg viewBox="0 0 100 150" preserveAspectRatio="xMidYMid meet">
                    <path d="M10 10 V100 L45 140 M55 140 L90 100 V10" />
                  </svg>
                  <div class="label">Bunker 4</div>
                </div>
                <div class="bunker">
                  <svg viewBox="0 0 100 150" preserveAspectRatio="xMidYMid meet">
                    <path d="M10 10 V100 L45 140 M55 140 L90 100 V10" />
                  </svg>
                  <div class="label">Bunker 5</div>
                </div>
                <div class="bunker">
                  <svg viewBox="0 0 100 150" preserveAspectRatio="xMidYMid meet">
                    <path d="M10 10 V100 L45 140 M55 140 L90 100 V10" />
                  </svg>
                  <div class="label">Bunker 6</div>
                </div>
              </div>
            </div>
          </div>
          <div></div>
          <div></div>

          <!-- Row 4: Coal Flow (moved down because diagram inserted above) -->
          <div class="mill coal-flow">Coal Flow(TPH)</div>
          <div class="mill"><input type="text" class="flow-input" data-mill="0" placeholder="TPH"></div>
          <div class="mill"><input type="text" class="flow-input" data-mill="1" placeholder="TPH"></div>
          <div class="mill"><input type="text" class="flow-input" data-mill="2" placeholder="TPH"></div>
          <div class="mill"><input type="text" class="flow-input" data-mill="3" placeholder="TPH"></div>
          <div class="mill"><input type="text" class="flow-input" data-mill="4" placeholder="TPH"></div>
          <div class="mill"><input type="text" class="flow-input" data-mill="5" placeholder="TPH"></div>
          <div></div>
          <div></div>

          <!-- Row 5: AFT (calculated per mill) -->
          <div class="mill aft-head">AFT(°C)</div>
          <div class="mill aft" data-mill="0">--</div>
          <div class="mill aft" data-mill="1">--</div>
          <div class="mill aft" data-mill="2">--</div>
          <div class="mill aft" data-mill="3">--</div>
          <div class="mill aft" data-mill="4">--</div>
          <div class="mill aft" data-mill="5">--</div>
          <div></div>
          <div></div>
        </div> <!-- end mills-grid -->
      </div> <!-- end main-container -->

      <!-- Summary moved out of diagram-row; class name preserved but it is fixed to the right side -->
      <div class="summary-table" aria-hidden="false">
        <div class="summary-cell summary-header">Generation (MW)</div>
        <div class="summary-cell"><input id="generation" class="generation-input" placeholder="MW" /></div>

        <div class="summary-cell summary-header">Total Coal Flow(TPH)</div>
        <div class="summary-cell" id="totalFlow">0</div>

        <div class="summary-cell summary-header">Average GCV(Kcal/kg)</div>
        <div class="summary-cell" id="avgGCV">0</div>

        <div class="summary-cell summary-header">Average AFT(°C)</div>
        <div class="summary-cell" id="avgAFT">--</div>

        <div class="summary-cell summary-header">Heat Rate(Kcal/kWh)</div>
        <div class="summary-cell" id="heatRate">--</div>

        <div class="summary-cell summary-header">Cost/MT</div>
        <div class="summary-cell" id="COSTRATE">--</div>
      </div>
    </div> <!-- end overviewTab -->

    <!-- Bunker 1 Panel -->
   <div id="bunker1Tab" class="tab-panel" style="display: none;">
  <div class="bunker-layout">
    
    <!-- LEFT SIDE: TABLE -->
    <div class="mills-grid" id="millsGrid">
      <!-- header row -->
      <div></div>
      <div class="mill green">BUNKER 1</div>
      <div class="mill gcv">GCV(Kcal/kg)</div>
      <div class="mill cost-head">Cost/MT</div>
      <div></div><div></div><div></div><div></div><div></div>

      <!-- Row 1 -->
      <div class="mill"><select class="dropdown" id="coalDrop1"></select></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="1" data-mill="0" placeholder="%"></div>
      <div class="mill"><div id="gcvBox1" class="gcv-box">--</div></div>
      <div class="mill"><input type="text" id="costBox1" class="cost-input" placeholder="Cost/MT"></div>
      <div></div><div></div><div></div><div></div><div></div>

      <!-- Row 2 -->
      <div class="mill"><select class="dropdown" id="coalDrop2"></select></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="2" data-mill="0" placeholder="%"></div>
      <div class="mill"><div id="gcvBox2" class="gcv-box">--</div></div>
      <div class="mill"><input type="text" id="costBox2" class="cost-input" placeholder="Cost/MT"></div>
      <div></div><div></div><div></div><div></div><div></div>

      <!-- Row 3 -->
      <div class="mill"><select class="dropdown" id="coalDrop3"></select></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="3" data-mill="0" placeholder="%"></div>
      <div class="mill"><div id="gcvBox3" class="gcv-box">--</div></div>
      <div class="mill"><input type="text" id="costBox3" class="cost-input" placeholder="Cost/MT"></div>
      <div></div><div></div><div></div><div></div><div></div>

      <!-- Row 4: Coal Flow -->
      <div class="mill coal-flow">Coal Flow(TPH)</div>
      <div class="mill"><input type="text" class="flow-input" data-mill="0" placeholder="TPH"></div>
      <div></div><div></div><div></div><div></div><div></div><div></div><div></div>

      <!-- Row 5: AFT -->
      <div class="mill aft-head">AFT(°C)</div>
      <div class="mill aft" data-mill="0">--</div>
      <div></div><div></div><div></div><div></div><div></div><div></div><div></div>
    </div> <!-- end mills-grid -->

    <!-- RIGHT SIDE: DIAGRAM -->
    <div class="diagram-container">
      <div class="layout">
        <div class="top-lines"></div>
        <div class="arrow" style="height:60px; left:40px;"></div>
        <div class="bunkers-grid">
          <div class="bunker">
            <svg viewBox="0 0 100 150" preserveAspectRatio="xMidYMid meet">
              <path d="M10 10 V100 L45 140 M55 140 L90 100 V10" />
            </svg>
            <div class="label">Bunker 1</div>
          </div>
        </div>
      </div>
    </div> <!-- end diagram-container -->

  </div> <!-- end bunker-layout -->
</div>


    <!-- Bunker 2 Panel -->
    <div id="bunker2Tab" class="tab-panel" style="display:none;">
<div class="bunker-layout">
    
    <!-- LEFT SIDE: TABLE -->
    <div class="mills-grid" id="millsGrid">
      <!-- header row -->
      <div></div>
      <div class="mill green">BUNKER 2</div>
      <div class="mill gcv">GCV(Kcal/kg)</div>
      <div class="mill cost-head">Cost/MT</div>
      <div></div><div></div><div></div><div></div><div></div>

      <!-- Row 1 -->
      <div class="mill"><select class="dropdown" id="coalDrop1"></select></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="1" data-mill="0" placeholder="%"></div>
      <div class="mill"><div id="gcvBox1" class="gcv-box">--</div></div>
      <div class="mill"><input type="text" id="costBox1" class="cost-input" placeholder="Cost/MT"></div>
      <div></div><div></div><div></div><div></div><div></div>

      <!-- Row 2 -->
      <div class="mill"><select class="dropdown" id="coalDrop2"></select></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="2" data-mill="0" placeholder="%"></div>
      <div class="mill"><div id="gcvBox2" class="gcv-box">--</div></div>
      <div class="mill"><input type="text" id="costBox2" class="cost-input" placeholder="Cost/MT"></div>
      <div></div><div></div><div></div><div></div><div></div>

      <!-- Row 3 -->
      <div class="mill"><select class="dropdown" id="coalDrop3"></select></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="3" data-mill="0" placeholder="%"></div>
      <div class="mill"><div id="gcvBox3" class="gcv-box">--</div></div>
      <div class="mill"><input type="text" id="costBox3" class="cost-input" placeholder="Cost/MT"></div>
      <div></div><div></div><div></div><div></div><div></div>

      <!-- Row 4: Coal Flow -->
      <div class="mill coal-flow">Coal Flow(TPH)</div>
      <div class="mill"><input type="text" class="flow-input" data-mill="0" placeholder="TPH"></div>
      <div></div><div></div><div></div><div></div><div></div><div></div><div></div>

      <!-- Row 5: AFT -->
      <div class="mill aft-head">AFT(°C)</div>
      <div class="mill aft" data-mill="0">--</div>
      <div></div><div></div><div></div><div></div><div></div><div></div><div></div>
    </div> <!-- end mills-grid -->

    <!-- RIGHT SIDE: DIAGRAM -->
    <div class="diagram-container">
      <div class="layout">
        <div class="top-lines"></div>
        <div class="arrow" style="height:60px; left:40px;"></div>
        <div class="bunkers-grid">
          <div class="bunker">
            <svg viewBox="0 0 100 150" preserveAspectRatio="xMidYMid meet">
              <path d="M10 10 V100 L45 140 M55 140 L90 100 V10" />
            </svg>
            <div class="label">Bunker 2</div>
          </div>
        </div>
      </div>
    </div> <!-- end diagram-container -->

  </div> <!-- end bunker-layout -->
    </div>

    <!-- Bunker 3 Panel -->
    <div id="bunker3Tab" class="tab-panel" style="display:none;">
<div class="bunker-layout">
    
    <!-- LEFT SIDE: TABLE -->
    <div class="mills-grid" id="millsGrid">
      <!-- header row -->
      <div></div>
      <div class="mill green">BUNKER 3</div>
      <div class="mill gcv">GCV(Kcal/kg)</div>
      <div class="mill cost-head">Cost/MT</div>
      <div></div><div></div><div></div><div></div><div></div>

      <!-- Row 1 -->
      <div class="mill"><select class="dropdown" id="coalDrop1"></select></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="1" data-mill="0" placeholder="%"></div>
      <div class="mill"><div id="gcvBox1" class="gcv-box">--</div></div>
      <div class="mill"><input type="text" id="costBox1" class="cost-input" placeholder="Cost/MT"></div>
      <div></div><div></div><div></div><div></div><div></div>

      <!-- Row 2 -->
      <div class="mill"><select class="dropdown" id="coalDrop2"></select></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="2" data-mill="0" placeholder="%"></div>
      <div class="mill"><div id="gcvBox2" class="gcv-box">--</div></div>
      <div class="mill"><input type="text" id="costBox2" class="cost-input" placeholder="Cost/MT"></div>
      <div></div><div></div><div></div><div></div><div></div>

      <!-- Row 3 -->
      <div class="mill"><select class="dropdown" id="coalDrop3"></select></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="3" data-mill="0" placeholder="%"></div>
      <div class="mill"><div id="gcvBox3" class="gcv-box">--</div></div>
      <div class="mill"><input type="text" id="costBox3" class="cost-input" placeholder="Cost/MT"></div>
      <div></div><div></div><div></div><div></div><div></div>

      <!-- Row 4: Coal Flow -->
      <div class="mill coal-flow">Coal Flow(TPH)</div>
      <div class="mill"><input type="text" class="flow-input" data-mill="0" placeholder="TPH"></div>
      <div></div><div></div><div></div><div></div><div></div><div></div><div></div>

      <!-- Row 5: AFT -->
      <div class="mill aft-head">AFT(°C)</div>
      <div class="mill aft" data-mill="0">--</div>
      <div></div><div></div><div></div><div></div><div></div><div></div><div></div>
    </div> <!-- end mills-grid -->

    <!-- RIGHT SIDE: DIAGRAM -->
    <div class="diagram-container">
      <div class="layout">
        <div class="top-lines"></div>
        <div class="arrow" style="height:60px; left:40px;"></div>
        <div class="bunkers-grid">
          <div class="bunker">
            <svg viewBox="0 0 100 150" preserveAspectRatio="xMidYMid meet">
              <path d="M10 10 V100 L45 140 M55 140 L90 100 V10" />
            </svg>
            <div class="label">Bunker 3</div>
          </div>
        </div>
      </div>
    </div> <!-- end diagram-container -->

  </div> <!-- end bunker-layout -->
    </div>

    <!-- Bunker 4 Panel -->
    <div id="bunker4Tab" class="tab-panel" style="display:none;">
    <div class="bunker-layout">
    
    <!-- LEFT SIDE: TABLE -->
    <div class="mills-grid" id="millsGrid">
      <!-- header row -->
      <div></div>
      <div class="mill green">BUNKER 4</div>
      <div class="mill gcv">GCV(Kcal/kg)</div>
      <div class="mill cost-head">Cost/MT</div>
      <div></div><div></div><div></div><div></div><div></div>

      <!-- Row 1 -->
      <div class="mill"><select class="dropdown" id="coalDrop1"></select></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="1" data-mill="0" placeholder="%"></div>
      <div class="mill"><div id="gcvBox1" class="gcv-box">--</div></div>
      <div class="mill"><input type="text" id="costBox1" class="cost-input" placeholder="Cost/MT"></div>
      <div></div><div></div><div></div><div></div><div></div>

      <!-- Row 2 -->
      <div class="mill"><select class="dropdown" id="coalDrop2"></select></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="2" data-mill="0" placeholder="%"></div>
      <div class="mill"><div id="gcvBox2" class="gcv-box">--</div></div>
      <div class="mill"><input type="text" id="costBox2" class="cost-input" placeholder="Cost/MT"></div>
      <div></div><div></div><div></div><div></div><div></div>

      <!-- Row 3 -->
      <div class="mill"><select class="dropdown" id="coalDrop3"></select></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="3" data-mill="0" placeholder="%"></div>
      <div class="mill"><div id="gcvBox3" class="gcv-box">--</div></div>
      <div class="mill"><input type="text" id="costBox3" class="cost-input" placeholder="Cost/MT"></div>
      <div></div><div></div><div></div><div></div><div></div>

      <!-- Row 4: Coal Flow -->
      <div class="mill coal-flow">Coal Flow(TPH)</div>
      <div class="mill"><input type="text" class="flow-input" data-mill="0" placeholder="TPH"></div>
      <div></div><div></div><div></div><div></div><div></div><div></div><div></div>

      <!-- Row 5: AFT -->
      <div class="mill aft-head">AFT(°C)</div>
      <div class="mill aft" data-mill="0">--</div>
      <div></div><div></div><div></div><div></div><div></div><div></div><div></div>
    </div> <!-- end mills-grid -->

    <!-- RIGHT SIDE: DIAGRAM -->
    <div class="diagram-container">
      <div class="layout">
        <div class="top-lines"></div>
        <div class="arrow" style="height:60px; left:40px;"></div>
        <div class="bunkers-grid">
          <div class="bunker">
            <svg viewBox="0 0 100 150" preserveAspectRatio="xMidYMid meet">
              <path d="M10 10 V100 L45 140 M55 140 L90 100 V10" />
            </svg>
            <div class="label">Bunker 4</div>
          </div>
        </div>
      </div>
    </div> <!-- end diagram-container -->

  </div> <!-- end bunker-layout -->
    </div>

    <!-- Bunker 5 Panel -->
    <div id="bunker5Tab" class="tab-panel" style="display:none;">
<div class="bunker-layout">
    
    <!-- LEFT SIDE: TABLE -->
    <div class="mills-grid" id="millsGrid">
      <!-- header row -->
      <div></div>
      <div class="mill green">BUNKER 5</div>
      <div class="mill gcv">GCV(Kcal/kg)</div>
      <div class="mill cost-head">Cost/MT</div>
      <div></div><div></div><div></div><div></div><div></div>

      <!-- Row 1 -->
      <div class="mill"><select class="dropdown" id="coalDrop1"></select></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="1" data-mill="0" placeholder="%"></div>
      <div class="mill"><div id="gcvBox1" class="gcv-box">--</div></div>
      <div class="mill"><input type="text" id="costBox1" class="cost-input" placeholder="Cost/MT"></div>
      <div></div><div></div><div></div><div></div><div></div>

      <!-- Row 2 -->
      <div class="mill"><select class="dropdown" id="coalDrop2"></select></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="2" data-mill="0" placeholder="%"></div>
      <div class="mill"><div id="gcvBox2" class="gcv-box">--</div></div>
      <div class="mill"><input type="text" id="costBox2" class="cost-input" placeholder="Cost/MT"></div>
      <div></div><div></div><div></div><div></div><div></div>

      <!-- Row 3 -->
      <div class="mill"><select class="dropdown" id="coalDrop3"></select></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="3" data-mill="0" placeholder="%"></div>
      <div class="mill"><div id="gcvBox3" class="gcv-box">--</div></div>
      <div class="mill"><input type="text" id="costBox3" class="cost-input" placeholder="Cost/MT"></div>
      <div></div><div></div><div></div><div></div><div></div>

      <!-- Row 4: Coal Flow -->
      <div class="mill coal-flow">Coal Flow(TPH)</div>
      <div class="mill"><input type="text" class="flow-input" data-mill="0" placeholder="TPH"></div>
      <div></div><div></div><div></div><div></div><div></div><div></div><div></div>

      <!-- Row 5: AFT -->
      <div class="mill aft-head">AFT(°C)</div>
      <div class="mill aft" data-mill="0">--</div>
      <div></div><div></div><div></div><div></div><div></div><div></div><div></div>
    </div> <!-- end mills-grid -->

    <!-- RIGHT SIDE: DIAGRAM -->
    <div class="diagram-container">
      <div class="layout">
        <div class="top-lines"></div>
        <div class="arrow" style="height:60px; left:40px;"></div>
        <div class="bunkers-grid">
          <div class="bunker">
            <svg viewBox="0 0 100 150" preserveAspectRatio="xMidYMid meet">
              <path d="M10 10 V100 L45 140 M55 140 L90 100 V10" />
            </svg>
            <div class="label">Bunker 5</div>
          </div>
        </div>
      </div>
    </div> <!-- end diagram-container -->

  </div> <!-- end bunker-layout -->
    </div>

    <!-- Bunker 6 Panel -->
    <div id="bunker6Tab" class="tab-panel" style="display:none;">
<div class="bunker-layout">
    
    <!-- LEFT SIDE: TABLE -->
    <div class="mills-grid" id="millsGrid">
      <!-- header row -->
      <div></div>
      <div class="mill green">BUNKER 6</div>
      <div class="mill gcv">GCV(Kcal/kg)</div>
      <div class="mill cost-head">Cost/MT</div>
      <div></div><div></div><div></div><div></div><div></div>

      <!-- Row 1 -->
      <div class="mill"><select class="dropdown" id="coalDrop1"></select></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="1" data-mill="0" placeholder="%"></div>
      <div class="mill"><div id="gcvBox1" class="gcv-box">--</div></div>
      <div class="mill"><input type="text" id="costBox1" class="cost-input" placeholder="Cost/MT"></div>
      <div></div><div></div><div></div><div></div><div></div>

      <!-- Row 2 -->
      <div class="mill"><select class="dropdown" id="coalDrop2"></select></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="2" data-mill="0" placeholder="%"></div>
      <div class="mill"><div id="gcvBox2" class="gcv-box">--</div></div>
      <div class="mill"><input type="text" id="costBox2" class="cost-input" placeholder="Cost/MT"></div>
      <div></div><div></div><div></div><div></div><div></div>

      <!-- Row 3 -->
      <div class="mill"><select class="dropdown" id="coalDrop3"></select></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="3" data-mill="0" placeholder="%"></div>
      <div class="mill"><div id="gcvBox3" class="gcv-box">--</div></div>
      <div class="mill"><input type="text" id="costBox3" class="cost-input" placeholder="Cost/MT"></div>
      <div></div><div></div><div></div><div></div><div></div>

      <!-- Row 4: Coal Flow -->
      <div class="mill coal-flow">Coal Flow(TPH)</div>
      <div class="mill"><input type="text" class="flow-input" data-mill="0" placeholder="TPH"></div>
      <div></div><div></div><div></div><div></div><div></div><div></div><div></div>

      <!-- Row 5: AFT -->
      <div class="mill aft-head">AFT(°C)</div>
      <div class="mill aft" data-mill="0">--</div>
      <div></div><div></div><div></div><div></div><div></div><div></div><div></div>
    </div> <!-- end mills-grid -->

    <!-- RIGHT SIDE: DIAGRAM -->
    <div class="diagram-container">
      <div class="layout">
        <div class="top-lines"></div>
        <div class="arrow" style="height:60px; left:40px;"></div>
        <div class="bunkers-grid">
          <div class="bunker">
            <svg viewBox="0 0 100 150" preserveAspectRatio="xMidYMid meet">
              <path d="M10 10 V100 L45 140 M55 140 L90 100 V10" />
            </svg>
            <div class="label">Bunker 6</div>
          </div>
        </div>
      </div>
    </div> <!-- end diagram-container -->

  </div> <!-- end bunker-layout -->
    </div>

  </div> <!-- end tabContent -->
</div> <!-- end outer flex container -->



<script>
/* ---------- shared state ---------- */
/* Robust Excel -> panel loader + panel-scoped init
   Paste this in your page (after HTML). It will:
   - read the excel file (requires XLSX lib present)
   - extract unique coal names
   - populate dropdowns in every .tab-panel
   - map some likely excel column names (GCV, Cost, Percentage1..6, SiO2, etc)
   - call per-panel update/init functions (calculateBlended, updateGCVCostBoxes, etc)
*/

/* ---------- shared state ---------- */
let excelData = []; // array of row objects from sheet

/* ---------- util: safe value get ---------- */
function safeTrim(v){ return (v===undefined || v===null) ? "" : String(v).trim(); }
function asNumber(v){ if(v===undefined || v===null || v==="") return 0; const n = Number(v); return isNaN(n) ? 0 : n; }

/* ---------- helper: find possible column key (case-insensitive) ---------- */
function findKeyIgnoreCase(obj, candidates){
  if(!obj) return null;
  const keys = Object.keys(obj);
  for(const c of candidates){
    const lower = c.toLowerCase();
    const found = keys.find(k => k.toLowerCase() === lower);
    if(found) return found;
  }
  // next: partial match
  for(const c of candidates){
    const lower = c.toLowerCase();
    const found = keys.find(k => k.toLowerCase().includes(lower));
    if(found) return found;
  }
  return null;
}

/* ---------- excel file handler ---------- */
const excelInput = document.getElementById('excelFile');
if(excelInput){
  excelInput.addEventListener('change', handleFile, false);
} else {
  console.warn('No #excelFile input found in DOM — file upload will not work.');
}

function handleFile(e){
  const file = e?.target?.files?.[0];
  if(!file) { console.warn('No file selected'); return; }
  try {
    document.getElementById('loader')?.style && (document.getElementById('loader').style.display = 'block');
  } catch(e){}
  const reader = new FileReader();
  reader.onload = function(ev){
    try {
      const data = new Uint8Array(ev.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const sheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[sheetName];
      excelData = XLSX.utils.sheet_to_json(worksheet, { defval: null });

      console.log('Excel loaded — rows:', excelData.length);
      if(excelData.length === 0){
        console.warn('Excel contains no rows');
      }

      // normalize header keys present in first row
      const first = excelData[0] || {};
      console.log('Detected columns:', Object.keys(first));

      // build unique coal list
      const coalSet = new Set();
      excelData.forEach(r => {
        const coalKey = findKeyIgnoreCase(r, ['Coal','coal','COAL']);
        const val = coalKey ? safeTrim(r[coalKey]) : null;
        if(val) coalSet.add(val);
      });
      const coalList = Array.from(coalSet);
      console.log('Extracted coalList:', coalList);

      // For every panel: populate dropdowns and set defaults, then initPanel or update if already inited
      const panels = Array.from(document.querySelectorAll('.tab-panel'));
      panels.forEach(panel => {
        // populate dropdown options
        const dropdowns = Array.from(panel.querySelectorAll('.dropdown'));
        dropdowns.forEach((drop, idx) => {
          // ensure each dropdown has a data-row attribute so code can match percentages
          if(!drop.dataset.row) drop.dataset.row = String(idx + 1);

          // clear and add options
          drop.innerHTML = '';
          const emptyOpt = document.createElement('option');
          emptyOpt.value = '';
          emptyOpt.textContent = '-- Select Coal --';
          drop.appendChild(emptyOpt);
          coalList.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.textContent = c;
            drop.appendChild(opt);
          });

          // decide selected value: if excel has rows and a coal for this index, choose it,
          // else choose first coal available
          const prefer = coalList[idx] || coalList[0] || '';
          drop.value = prefer;
        });

        // fill cost/gcv boxes if matching excel rows exist
        // For each dropdown, find excel row by coal and fill respective gcv-box / cost-input
        const drops = Array.from(panel.querySelectorAll('.dropdown'));
        drops.forEach((drop, i) => {
          const coalName = drop.value;
          const row = excelData.find(r => {
            const key = findKeyIgnoreCase(r, ['Coal','coal','COAL']);
            return key && safeTrim(r[key]) === coalName;
          });
          // gcvBox (if exists)
          const gcvBox = panel.querySelectorAll('.gcv-box')[i];
          if(gcvBox){
            const gcvKey = findKeyIgnoreCase(row, ['GCV','gcv','Gcv','G.C.V']);
            gcvBox.innerText = row && gcvKey ? (safeTrim(row[gcvKey]) !== '' ? Number(row[gcvKey]).toFixed(2) : '--') : '--';
          }
          // cost input
          const costInput = panel.querySelectorAll('.cost-input')[i];
          if(costInput && row){
            const costKey = findKeyIgnoreCase(row, ['Cost','COST','Price','PRICE']);
            costInput.value = costKey ? (row[costKey] ?? '') : (row['Cost'] ?? row['Price'] ?? '');
          }
          // Try to pre-fill percentage inputs for this coal if sheet has Percentage columns
          // We'll look for Percentage1..6 or Perc1..6 or P1..6 etc
          const percCandidates = ['Percentage','Perc','P','MillPercent','Percent'];
          for(let m = 0; m < 6; m++){
            // look for exact keys like Percentage1, Perc1, P1
            const poss = [
              `Percentage${m+1}`,
              `Perc${m+1}`,
              `P${m+1}`,
              `Percent${m+1}`,
              `Mill${m+1}`,
              `M${m+1}`
            ];
            const key = findKeyIgnoreCase(row, poss);
            if(key){
              const input = panel.querySelector(`.percentage-input[data-row="${i+1}"][data-mill="${m}"]`);
              if(input) input.value = row[key] ?? '';
            }
          }
        });

        // mark excel-loaded on panel so initPanel uses data immediately
        panel._excelLoaded = true;

        // if panel is already initialized, run updates; else keep for init on first open
        if(panel._inited){
          updateGCVCostBoxes(panel);
          calculateBlended(panel);
          validateMillPercentages(panel);
          updateBunkerColors(panel);
        }
      });

      // If overview visible, update its global summary immediately
      const visibleOverview = document.getElementById('overviewTab');
      if(visibleOverview && visibleOverview.style.display === 'block'){
        updateGCVCostBoxes(visibleOverview);
        calculateBlended(visibleOverview);
        validateMillPercentages(visibleOverview);
        updateBunkerColors(visibleOverview);
      }

      console.log('Excel distribution complete — panels updated.');

    } catch(err){
      console.error('Error processing excel:', err);
      alert('Failed to read Excel file. See console for details.');
    } finally {
      try { document.getElementById('loader')?.style && (document.getElementById('loader').style.display = 'none'); } catch(e){}
    }
  };
  reader.onerror = function(err){
    console.error('FileReader error', err);
    alert('Error reading file.');
  };
  reader.readAsArrayBuffer(file);
}// filled by your file reader

/* ---------- helper Excel functions (shared) ---------- */
function findRowForCoal(coalName) {
  if (!coalName) return null;
  return excelData.find(r => {
    const c = r["Coal"];
    return (c !== undefined && c !== null && String(c).trim() === String(coalName).trim());
  }) || null;
}
function getValue(coalName, key) {
  const row = findRowForCoal(coalName);
  if (!row) return 0;
  const v = row[key];
  if (v === null || v === undefined || v === "") return 0;
  return Number(v) || 0;
}

/* ---------- populate dropdown options for a panel (if excelData present) ---------- */
function populateDropdownsForPanel(panel) {
  if (!panel) return;
  const dropdowns = panel.querySelectorAll('.dropdown');
  dropdowns.forEach(drop => {
    // clear existing
    drop.innerHTML = '';
    const empty = document.createElement('option');
    empty.value = '';
    empty.textContent = '-- Select Coal --';
    drop.appendChild(empty);
    // add excel values
    const set = new Set();
    excelData.forEach(r => { if (r.Coal && String(r.Coal).trim()) set.add(String(r.Coal).trim()) });
    Array.from(set).forEach(v => {
      const opt = document.createElement('option');
      opt.value = v;
      opt.textContent = v;
      drop.appendChild(opt);
    });
  });
}

/* ---------- panel-scoped update functions ---------- */
function updateGCVCostBoxes(panel) {
  if (!panel) return;
  const drops = Array.from(panel.querySelectorAll('.dropdown'));
  const gcvBoxes = Array.from(panel.querySelectorAll('.gcv-box'));
  const costInputs = Array.from(panel.querySelectorAll('.cost-input'));
  for (let i = 0; i < 3; i++) {
    const coalName = drops[i]?.value || '';
    const row = findRowForCoal(coalName);
    if (gcvBoxes[i]) {
      gcvBoxes[i].innerText = row ? ((row.GCV!==undefined && row.GCV!==null && row.GCV!=='') ? Number(row.GCV).toFixed(2) : '--') : '--';
    }
    if (costInputs[i]) {
      const c = row ? (row.Cost ?? row.COST ?? row.Price ?? '') : '';
      costInputs[i].value = c !== undefined ? String(c) : '';
    }
  }
}

function calcAFT(ox){
  const total = Object.values(ox).reduce((a,b)=>a+b,0);
  if(total === 0) return 0;
  const sum = (ox["SiO₂"]||0) + (ox["Al₂O₃"]||0);
  let aft = 0;
  if(sum < 55){
    aft = 1245 + (1.1*(ox["SiO₂"]||0)) + (0.95*(ox["Al₂O₃"]||0)) - (2.5*(ox["Fe₂O₃"]||0)) - (2.98*(ox["CaO"]||0)) - (4.5*(ox["MgO"]||0)) - (7.89*((ox["Na₂O"]||0) + (ox["K₂O"]||0))) - (1.7*(ox["SO₃"]||0)) - (0.63*(ox["TiO₂"]||0));
  } else if(sum < 75){
    aft = 1323 + (1.45*(ox["SiO₂"]||0)) + (0.683*(ox["Al₂O₃"]||0)) - (2.39*(ox["Fe₂O₃"]||0)) - (3.1*(ox["CaO"]||0)) - (4.5*(ox["MgO"]||0)) - (7.49*((ox["Na₂O"]||0) + (ox["K₂O"]||0))) - (2.1*(ox["SO₃"]||0)) - (0.63*(ox["TiO₂"]||0));
  } else {
    aft = 1395 + (1.2*(ox["SiO₂"]||0)) + (0.9*(ox["Al₂O₃"]||0)) - (2.5*(ox["Fe₂O₃"]||0)) - (3.1*(ox["CaO"]||0)) - (4.5*(ox["MgO"]||0)) - (7.2*((ox["Na₂O"]||0) + (ox["K₂O"]||0))) - (1.7*(ox["SO₃"]||0)) - (0.63*(ox["TiO₂"]||0));
  }
  return Number(aft);
}

function calculateBlended(panel) {
  if (!panel) return;
  const drops = Array.from(panel.querySelectorAll('.dropdown'));
  const coal1 = drops[0]?.value || '';
  const coal2 = drops[1]?.value || '';
  const coal3 = drops[2]?.value || '';

  const oxKeys = ["SiO₂","Al₂O₃","Fe₂O₃","CaO","MgO","Na₂O","K₂O","SO₃","TiO₂"];

  let totalFlow = 0, weightedGCV = 0, weightedAFT = 0;

  for (let m = 0; m < 6; m++) {
    const p1 = parseFloat(panel.querySelector(`.percentage-input[data-row="1"][data-mill="${m}"]`)?.value) || 0;
    const p2 = parseFloat(panel.querySelector(`.percentage-input[data-row="2"][data-mill="${m}"]`)?.value) || 0;
    const p3 = parseFloat(panel.querySelector(`.percentage-input[data-row="3"][data-mill="${m}"]`)?.value) || 0;

    const gcv1 = getValue(coal1, "GCV"), gcv2 = getValue(coal2, "GCV"), gcv3 = getValue(coal3, "GCV");
    const blendedGCV = (gcv1*(p1/100)) + (gcv2*(p2/100)) + (gcv3*(p3/100));

    let ox = {};
    oxKeys.forEach(k => {
      ox[k] = (getValue(coal1,k)*(p1/100)) + (getValue(coal2,k)*(p2/100)) + (getValue(coal3,k)*(p3/100));
    });

    const aftVal = calcAFT(ox);
    const aftCell = panel.querySelector(`.aft[data-mill="${m}"]`);
    if (aftCell) aftCell.innerText = isFinite(aftVal) ? Number(aftVal).toFixed(2) : '--';

    const flow = parseFloat(panel.querySelector(`.flow-input[data-mill="${m}"]`)?.value) || 0;
    if (flow > 0) {
      totalFlow += flow;
      weightedGCV += (flow * blendedGCV);
      weightedAFT += (flow * aftVal);
    }
  }

  // If this is overview panel, update global summary boxes:
  if (panel.id === 'overviewTab') {
    const totalFlowEl = document.getElementById('totalFlow');
    const avgGCVEl = document.getElementById('avgGCV');
    const avgAFTEl = document.getElementById('avgAFT');
    if (totalFlowEl) totalFlowEl.innerText = Number(totalFlow).toFixed(2);
    if (avgGCVEl) avgGCVEl.innerText = totalFlow>0 ? Number(weightedGCV/totalFlow).toFixed(2) : 0;
    if (avgAFTEl) avgAFTEl.innerText = totalFlow>0 ? Number(weightedAFT/totalFlow).toFixed(2) : '--';
    // heat rate & costrate only update overview's global boxes
    const generation = parseFloat(document.getElementById('generation')?.value) || 0;
    if (generation > 0 && totalFlow > 0) document.getElementById('heatRate').innerText = Number((totalFlow*(weightedGCV/totalFlow))/generation).toFixed(2);
    else document.getElementById('heatRate').innerText = '--';
  }

  // compute costrate for panel (if needed) or update overview global COSTRATE only if panel is overview
  const costInputs = panel.querySelectorAll('.cost-input');
  const c1 = parseFloat(costInputs[0]?.value) || 0;
  const c2 = parseFloat(costInputs[1]?.value) || 0;
  const c3 = parseFloat(costInputs[2]?.value) || 0;

  function getCoalQty(rowIndex) {
    let total = 0;
    for (let mm = 0; mm < 6; mm++) {
      total += parseFloat(panel.querySelector(`.percentage-input[data-row="${rowIndex}"][data-mill="${mm}"]`)?.value) || 0;
    }
    return total;
  }
  const q1 = getCoalQty(1), q2 = getCoalQty(2), q3 = getCoalQty(3);
  const totalCost = (q1*c1) + (q2*c2) + (q3*c3);
  const totalQty = q1+q2+q3;
  const costRate = totalQty>0 ? (totalCost/totalQty) : 0;
  if (panel.id === 'overviewTab') {
    const costEl = document.getElementById('COSTRATE');
    if (costEl) costEl.innerText = costRate.toFixed(2);
  }
}

/* ---------- validate sums and header color (panel-scoped) ---------- */
function validateMillPercentages(panel) {
  if (!panel) return;
  for (let m = 0; m < 6; m++) {
    let hasPercent = false;
    for (let r = 1; r <= 3; r++) {
      const val = parseFloat(panel.querySelector(`.percentage-input[data-row="${r}"][data-mill="${m}"]`)?.value) || 0;
      if (val > 0) { hasPercent = true; break; }
    }
    const flow = parseFloat(panel.querySelector(`.flow-input[data-mill="${m}"]`)?.value) || 0;
    const headers = Array.from(panel.querySelectorAll('.mills-grid > .mill'));
    const header = headers.find(el => el.textContent.trim().startsWith(`BUNKER ${m+1}`));
    if (!header) continue;
    header.classList.remove('red','green');
    if (hasPercent && flow > 0) header.classList.add('red'); else header.classList.add('green');
  }
}

/* ---------- update bunker SVG fill (panel-scoped) ---------- */
function updateBunkerColors(panel) {
  if (!panel) return;
  const coalColors = ['#f39c12','#3498db','#2ecc71'];
  const bunkers = Array.from(panel.querySelectorAll('.bunker'));
  const svgWidth = 100, topY=10, midY=100, bottomY=140, usableH = bottomY-topY;
  const outlinePath = `M10 ${topY} L10 ${midY} L45 ${bottomY} L55 ${bottomY} L90 ${midY} L90 ${topY} Z`;
  bunkers.forEach((bunker, idx) => {
    const svg = bunker.querySelector('svg');
    if (!svg) return;
    const p1 = parseFloat(panel.querySelector(`.percentage-input[data-row="1"][data-mill="${idx}"]`)?.value) || 0;
    const p2 = parseFloat(panel.querySelector(`.percentage-input[data-row="2"][data-mill="${idx}"]`)?.value) || 0;
    const p3 = parseFloat(panel.querySelector(`.percentage-input[data-row="3"][data-mill="${idx}"]`)?.value) || 0;
    const clipId = `clip-${panel.id}-${idx}`;
    let inner = `<defs><clipPath id="${clipId}"><path d="${outlinePath}" /></clipPath></defs>`;
    let cum=0;
    [p1,p2,p3].forEach((pct,i) => {
      if (pct<=0) return;
      const h = (pct/100)*usableH;
      const y = bottomY - (cum + h);
      cum += h;
      inner += `<rect x="0" y="${y}" width="${svgWidth}" height="${h}" fill="${coalColors[i]}" clip-path="url(#${clipId})" />`;
    });
    inner += `<path d="M10 ${topY} L10 ${midY}" stroke="black" fill="none" stroke-width="2" />`;
    inner += `<path d="M90 ${topY} L90 ${midY}" stroke="black" fill="none" stroke-width="2" />`;
    inner += `<path d="M10 ${midY} L45 ${bottomY}" stroke="black" fill="none" stroke-width="2" />`;
    inner += `<path d="M90 ${midY} L55 ${bottomY}" stroke="black" fill="none" stroke-width="2" />`;
    svg.setAttribute('viewBox', `0 0 ${svgWidth} ${svgWidth * 1.5}`);
    svg.innerHTML = inner;
  });
}

/* ---------- initialize a panel once (attach handlers) ---------- */
function initPanel(panel) {
  if (!panel) return;
  if (panel._inited) return; // avoid double init
  // populate dropdowns (if Excel loaded)
  if (excelData && excelData.length) populateDropdownsForPanel(panel);

  // Attach percentage input handlers
  panel.querySelectorAll('.percentage-input').forEach(inp => {
    inp.dataset.prev = inp.value || '';
    inp.addEventListener('focus', () => inp.dataset.prev = inp.value);
    inp.addEventListener('input', function(){
      const millIndex = Number(this.dataset.mill);
      let sum = 0;
      for (let r=1; r<=3; r++){
        sum += parseFloat(panel.querySelector(`.percentage-input[data-row="${r}"][data-mill="${millIndex}"]`)?.value) || 0;
      }
      if (sum > 100) {
        this.value = this.dataset.prev || '';
        alert(`Total for Mill ${String.fromCharCode(65+millIndex)} cannot exceed 100%`);
        calculateBlended(panel); validateMillPercentages(panel); updateBunkerColors(panel);
        return;
      }
      this.dataset.prev = this.value;
      calculateBlended(panel); validateMillPercentages(panel); updateBunkerColors(panel);
    });
  });

  // flow & cost inputs
  panel.querySelectorAll('.flow-input, .cost-input').forEach(inp => {
    inp.addEventListener('input', () => { calculateBlended(panel); validateMillPercentages(panel); updateBunkerColors(panel); });
  });

  // dropdown change
  panel.querySelectorAll('.dropdown').forEach(d => {
    d.addEventListener('change', () => { updateGCVCostBoxes(panel); calculateBlended(panel); validateMillPercentages(panel); updateBunkerColors(panel); });
  });

  // mark initialized
  panel._inited = true;

  // run initial calculations for the panel
  updateGCVCostBoxes(panel); calculateBlended(panel); validateMillPercentages(panel); updateBunkerColors(panel);
}

/* ---------- tab show logic: init panel when shown ---------- */
document.addEventListener('DOMContentLoaded', () => {
  const tabBtns = document.querySelectorAll('.tab-btn');
  const panels = document.querySelectorAll('.tab-panel');

  function hideAll() {
    panels.forEach(p => p.style.display = 'none');
    tabBtns.forEach(b => b.classList.remove('active'));
  }

  tabBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const tabName = btn.dataset.tab;
      const panel = document.getElementById(tabName + 'Tab');
      if (!panel) return;
      const isOpen = panel.style.display === 'block';
      if (isOpen) { panel.style.display = 'none'; btn.classList.remove('active'); }
      else {
        hideAll();
        panel.style.display = 'block';
        btn.classList.add('active');
        // initialize this panel now (safe & idempotent)
        initPanel(panel);
      }
    });
  });

  // Optionally initialize overview immediately if it's visible by default:
  const overview = document.getElementById('overviewTab');
  if (overview && overview.style.display === 'block') initPanel(overview);
});
</script>

</body>
</html>

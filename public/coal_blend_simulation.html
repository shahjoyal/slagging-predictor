<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Coal Blending Ratio â€” light theme</title>
     <style>
    :root{
      --bg: #F7F8FA;        
      --card: #FFFFFF;      
      --muted: #6b7280;     
      --text: #111827;      
      --accent: #b71c1c;    /* red */
      --green: #16a34a;     /* green */
      --border: #E5E7EB;    
      --input-border: #D1D5DB; 
      --accent-btn: #0f4db2;
      --color-blue-800: oklch(.424 .199 265.638);
    }

    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      padding: 90px 14px 8px; /* top padding increased for navbar */
    }

    h1 {
      color: var(--text);
      margin: 8px 0;
      font-size: 1.3rem;
      text-align: left;
    }

    .upload-btn {
      display: inline-block;
      background: #02008a;
      color: #fff;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      margin: 6px 3px;
      border: none;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      font-size: 0.85rem;
    }

    .main-container {
      display:flex;
      flex-direction:column;
      gap:14px;
      max-width: 900px;
      align-items:flex-start;
    }

    .mills-grid {
      display: grid;
      grid-template-columns: 140px repeat(8, 1fr);
      gap: 6px;
      margin: 8px 0;
      align-items: center;
      font-size: 0.8rem;
      width: 100%;
    }

    .mill {
      background: var(--card);
      border: 1px solid var(--border);
      text-align: center;
      padding: 6px;
      color: var(--text);
      min-height: 34px;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 1px 2px rgba(16,24,40,0.03);
      border-radius: 6px;
    }

    /* red state (when sum == 100) */
    .mill.red {
      background: var(--accent);
      color: #fff;
      font-weight:700;
      border: 1px solid rgba(0,0,0,0.08);
    }

    /* green state (default when sum < 100) */
    .mill.green {
      background: var(--green);
      color: #fff;
      font-weight:700;
      border: 1px solid rgba(0,0,0,0.06);
    }

    .mill.coal-flow,
    .mill.gcv,
    .mill.aft-head,
    .mill.cost-head {
      background: #02008a;
      color: #fff;
      font-weight: 600;
    }

    .dropdown {
      width: 105%;
      padding:8px;
      background: #fff;
      color: var(--text);
      border: 1px solid var(--input-border);
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 0.8rem;
    }

    .percentage-input, .flow-input, .cost-input, .generation-input {
      width: 88%;
      padding:6px;
      background: #fff;
      border:1px solid var(--input-border);
      color: var(--text);
      text-align:center;
      border-radius: 4px;
      box-sizing: border-box;
      outline: none;
      font-size: 0.8rem;
    }

    .percentage-input{
      border:2px solid #02008a
    }

    .percentage-input::placeholder, .flow-input::placeholder, .cost-input::placeholder {
      color: var(--muted);
    }
.flow-input{
  border:2px solid #F1C40F
}

.generation-input{
  border:2px solid #F1C40F
}
    .cost-input { border:2px solid #F1C40F; background:#fff; }

    .gcv-box {
      width: 92%;
      padding:6px;
      text-align:center;
      font-weight:700;
      background:#F3F4F6;
      border:1px solid var(--input-border);
      color: var(--text);
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 0.8rem;
    }

    .aft { min-height: 28px; color: var(--text); }

    .summary-table {
      display: grid;
      grid-template-columns: 140px 110px;
      gap:6px;
      width:280px;
      margin-bottom:14px;
      font-size: 0.8rem;
    }

    .summary-cell {
      background: var(--card);
      border:1px solid var(--border);
      padding:8px;
      color:var(--text);
      text-align:center;
      border-radius:6px;
    }

    .summary-header {
      background:#F3F4F6;
      font-weight:700;
      color:var(--text);
    }

    .summary-cell.summary-header {
      background: #02008a;
      font-weight: 700;
      color: #fff;
    }

   .navbar {
            
            width: 100%;
            background-color: #f7f8fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            color: white;
            position: fixed;
            top: 0;
            left: 0;
            height: 65px;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .navbar img {
            height: 95px;
            margin-right: 10px;
            margin-left: 0px;
        }

        .nav-buttons {
            display: flex;
            gap: 10px; /* Use 'gap' for spacing between flex items */
            margin-right: 20px;
            
        }

        .navbar h1 {
            margin-left: 0px;
            font-size: 20px; /* Adjust font size as needed */
            color: black;
            
        }

       .navbar button {
            padding: 10px 15px;
            background-color: #02008a;
            color: #ffffff;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            margin-right: 20px;
            font-weight: bold;
        }
        
        .navbar button:hover {
            background-color: #001cbb;
        }
    /* compact adjustments to avoid scrolling */
    body {
      padding: 80px 6px 6px; /* reduce padding */
    }

    .mills-grid {
      gap: 4px;
      font-size: 0.72rem;
    }

    .mill {
      padding: 4px;
      min-height: 28px;
      font-size: 0.72rem;
    }

    .dropdown,
    .percentage-input,
    .flow-input,
    .cost-input,
    .gcv-box,
    .generation-input {
      font-size: 0.72rem;
      padding: 4px;
    }
    .dropdown {
  font-size:0.6rem;
    }
    #loader { display:none; color:var(--muted); margin-top:4px; font-size:0.8rem; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
if(localStorage.getItem('isLoggedIn') !== 'true') {
    alert('You must login first!');
    window.location.href = '/login.html'; 
} else {
    document.body.style.display = 'block';
}
</script>
</head>
<body>
 <div class="navbar">
    <img src="/images/abhitech-logo.png" alt="Company Logo">
    <h1>COAL BLENDING RATIO</h1>
    <div class="nav-buttons">
      <button onclick="window.location.href='slagging_coal_page.html'">Calculation</button>
      <button onclick="window.location.href='coal_table.html'">Coal Properties</button>
      <button onclick="window.location.href='model.html'">Model</button>
      <button id="downloadPDF">Download PDF</button>
    </div>
  </div>
  <div style="margin-top:8px;">
    <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" style="display:none" />
    <label for="excelFile" class="upload-btn">Upload Excel</label>
  </div>

  <div id="loader">Loading... please wait</div>

  <div class="main-container">
    <div class="mills-grid" id="millsGrid">
      <!-- header row -->
      <div></div>
      <!-- START: changed headers to green by default -->
      <div class="mill green">MILL-A</div>
      <div class="mill green">MILL-B</div>
      <div class="mill green">MILL-C</div>
      <div class="mill green">MILL-D</div>
      <div class="mill green">MILL-E</div>
      <div class="mill green">MILL-F</div>
      <!-- END -->
      <div class="mill gcv">GCV(Kcal/kg)</div>
      <div class="mill cost-head">Cost/MT</div>

      <!-- Row 1: Coal selection 1 (first cell = dropdown, columns 2-7 = % under mills) -->
      <div class="mill"><select class="dropdown" id="coalDrop1"></select></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="1" data-mill="0" placeholder="%"></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="1" data-mill="1" placeholder="%"></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="1" data-mill="2" placeholder="%"></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="1" data-mill="3" placeholder="%"></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="1" data-mill="4" placeholder="%"></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="1" data-mill="5" placeholder="%"></div>
      <div class="mill"><div id="gcvBox1" class="gcv-box">--</div></div>
      <div class="mill"><input type="text" id="costBox1" class="cost-input" placeholder="Cost/MT"></div>

      <!-- Row 2: Coal selection 2 -->
      <div class="mill"><select class="dropdown" id="coalDrop2"></select></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="2" data-mill="0" placeholder="%"></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="2" data-mill="1" placeholder="%"></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="2" data-mill="2" placeholder="%"></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="2" data-mill="3" placeholder="%"></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="2" data-mill="4" placeholder="%"></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="2" data-mill="5" placeholder="%"></div>
      <div class="mill"><div id="gcvBox2" class="gcv-box">--</div></div>
      <div class="mill"><input type="text" id="costBox2" class="cost-input" placeholder="Cost/MT"></div>

      <!-- Row 3: Coal selection 3 -->
      <div class="mill"><select class="dropdown" id="coalDrop3"></select></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="3" data-mill="0" placeholder="%"></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="3" data-mill="1" placeholder="%"></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="3" data-mill="2" placeholder="%"></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="3" data-mill="3" placeholder="%"></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="3" data-mill="4" placeholder="%"></div>
      <div class="mill"><input type="text" class="percentage-input" data-row="3" data-mill="5" placeholder="%"></div>
      <div class="mill"><div id="gcvBox3" class="gcv-box">--</div></div>
      <div class="mill"><input type="text" id="costBox3" class="cost-input" placeholder="Cost/MT"></div>

      <!-- Row 4: Coal Flow -->
      <div class="mill coal-flow">Coal Flow(TPH)</div>
      <div class="mill"><input type="text" class="flow-input" data-mill="0" placeholder="TPH"></div>
      <div class="mill"><input type="text" class="flow-input" data-mill="1" placeholder="TPH"></div>
      <div class="mill"><input type="text" class="flow-input" data-mill="2" placeholder="TPH"></div>
      <div class="mill"><input type="text" class="flow-input" data-mill="3" placeholder="TPH"></div>
      <div class="mill"><input type="text" class="flow-input" data-mill="4" placeholder="TPH"></div>
      <div class="mill"><input type="text" class="flow-input" data-mill="5" placeholder="TPH"></div>
      <div></div>
      <div></div>

      <!-- Row 5: AFT (calculated per mill) -->
      <div class="mill aft-head">AFT(Â°C)</div>
      <div class="mill aft" data-mill="0">--</div>
      <div class="mill aft" data-mill="1">--</div>
      <div class="mill aft" data-mill="2">--</div>
      <div class="mill aft" data-mill="3">--</div>
      <div class="mill aft" data-mill="4">--</div>
      <div class="mill aft" data-mill="5">--</div>
      <div></div>
      <div></div>
    </div>

    <!-- Summary -->
    <div class="summary-table" aria-hidden="false">
      <div class="summary-cell summary-header">Generation (MW)</div>
      <div class="summary-cell"><input id="generation" class="generation-input" placeholder="MW" /></div>

      <div class="summary-cell summary-header">Total Coal Flow(TPH)</div>
      <div class="summary-cell" id="totalFlow">0</div>

      <div class="summary-cell summary-header">Average GCV(Kcal/kg)</div>
      <div class="summary-cell" id="avgGCV">0</div>

      <div class="summary-cell summary-header">Average AFT(Â°C)</div>
      <div class="summary-cell" id="avgAFT">--</div>

      <div class="summary-cell summary-header">Heat Rate(Kcal/kWh)</div>
      <div class="summary-cell" id="heatRate">--</div>
      
      <div class="summary-cell summary-header">Cost/MT</div>
      <div class="summary-cell" id="COSTRATE">--</div>
    </div>
  </div>

<script>
  let excelData = [];
//GCV (kcal/kg)
//Heat rate (kcal/kWh)
  // load excel and populate dropdowns
  document.getElementById("excelFile").addEventListener("change", handleFile, false);
  function handleFile(e){
    const file = e.target.files[0];
    if(!file) return;
    document.getElementById("loader").style.display = "block";
    const reader = new FileReader();
    reader.onload = function(event){
      setTimeout(() => {
        try {
          const data = new Uint8Array(event.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];
          excelData = XLSX.utils.sheet_to_json(worksheet, { defval: null });

          // get unique coal names
          const coalValues = [...new Set(excelData.map(r => r["Coal"]).filter(v => v))];

          [1,2,3].forEach(i=>{
            const drop = document.getElementById("coalDrop"+i);
            drop.innerHTML = "";
            const empty = document.createElement("option");
            empty.value = ""; empty.textContent = "-- Select Coal --";
            drop.appendChild(empty);
            coalValues.forEach(c=>{
              const opt = document.createElement("option");
              opt.value = c; opt.textContent = c;
              drop.appendChild(opt);
            });
          });

          attachAutoUpdate();
        } catch(err){
          console.error(err);
          alert("Error reading file.");
        } finally {
          document.getElementById("loader").style.display = "none";
        }
      }, 250);
    };
    reader.readAsArrayBuffer(file);
  }

  // helper: lookup numeric cell for a coal
  function findRowForCoal(coalName){
    if(!coalName) return null;
    return excelData.find(r => {
      const c = r["Coal"];
      return (c !== undefined && c !== null && String(c) === String(coalName));
    }) || null;
  }
  function getValue(coalName, key){
    const row = findRowForCoal(coalName);
    if(!row) return 0;
    const v = row[key];
    if(v === null || v === undefined || v === "") return 0;
    return Number(v) || 0;
  }

  // AFT formula exactly as provided (returns a number)
  function calcAFT(ox){
    const total = Object.values(ox).reduce((a,b)=>a+b,0);
    if(total === 0) return 0;
    const sum = (ox["SiOâ‚‚"]||0) + (ox["Alâ‚‚Oâ‚ƒ"]||0);
    let aft = 0;
    if(sum < 55){
      aft = 1245 + (1.1*(ox["SiOâ‚‚"]||0)) + (0.95*(ox["Alâ‚‚Oâ‚ƒ"]||0)) - (2.5*(ox["Feâ‚‚Oâ‚ƒ"]||0)) - (2.98*(ox["CaO"]||0)) - (4.5*(ox["MgO"]||0)) - (7.89*((ox["Naâ‚‚O"]||0) + (ox["Kâ‚‚O"]||0))) - (1.7*(ox["SOâ‚ƒ"]||0)) - (0.63*(ox["TiOâ‚‚"]||0));
    } else if(sum < 75){
      aft = 1323 + (1.45*(ox["SiOâ‚‚"]||0)) + (0.683*(ox["Alâ‚‚Oâ‚ƒ"]||0)) - (2.39*(ox["Feâ‚‚Oâ‚ƒ"]||0)) - (3.1*(ox["CaO"]||0)) - (4.5*(ox["MgO"]||0)) - (7.49*((ox["Naâ‚‚O"]||0) + (ox["Kâ‚‚O"]||0))) - (2.1*(ox["SOâ‚ƒ"]||0)) - (0.63*(ox["TiOâ‚‚"]||0));
    } else {
      aft = 1395 + (1.2*(ox["SiOâ‚‚"]||0)) + (0.9*(ox["Alâ‚‚Oâ‚ƒ"]||0)) - (2.5*(ox["Feâ‚‚Oâ‚ƒ"]||0)) - (3.1*(ox["CaO"]||0)) - (4.5*(ox["MgO"]||0)) - (7.2*((ox["Naâ‚‚O"]||0) + (ox["Kâ‚‚O"]||0))) - (1.7*(ox["SOâ‚ƒ"]||0)) - (0.63*(ox["TiOâ‚‚"]||0));
    }
    return Number(aft);
  }
//gcv - Kcal
//cost per MT
//AFT degree celcius
//coal flow TPH
//heat rate Kcal per KWH
  // update GCV & Cost boxes (the 3 boxes in GCV & Cost columns)
  function updateGCVCostBoxes(){
    const c1 = document.getElementById("coalDrop1").value;
    const c2 = document.getElementById("coalDrop2").value;
    const c3 = document.getElementById("coalDrop3").value;

    const r1 = findRowForCoal(c1);
    const r2 = findRowForCoal(c2);
    const r3 = findRowForCoal(c3);

    document.getElementById("gcvBox1").innerText = r1 ? ( (r1["GCV"]!==undefined && r1["GCV"]!==null && r1["GCV"]!=="") ? Number(r1["GCV"]).toFixed(2) : "--") : "--";
    document.getElementById("gcvBox2").innerText = r2 ? ( (r2["GCV"]!==undefined && r2["GCV"]!==null && r2["GCV"]!=="") ? Number(r2["GCV"]).toFixed(2) : "--") : "--";
    document.getElementById("gcvBox3").innerText = r3 ? ( (r3["GCV"]!==undefined && r3["GCV"]!==null && r3["GCV"]!=="") ? Number(r3["GCV"]).toFixed(2) : "--") : "--";

    function extractCost(row){
      if(!row) return "";
      if(row["Cost"] !== undefined) return String(row["Cost"]);
      if(row["COST"] !== undefined) return String(row["COST"]);
      if(row["Price"] !== undefined) return String(row["Price"]);
      return "";
    }
    document.getElementById("costBox1").value = extractCost(r1);
    document.getElementById("costBox2").value = extractCost(r2);
    document.getElementById("costBox3").value = extractCost(r3);
  }

  // main calculations: per-mill blended GCV, per-mill AFT, totals & averages
  function calculateBlended(){
    const coal1 = document.getElementById("coalDrop1").value;
    const coal2 = document.getElementById("coalDrop2").value;
    const coal3 = document.getElementById("coalDrop3").value;

    const oxKeys = ["SiOâ‚‚","Alâ‚‚Oâ‚ƒ","Feâ‚‚Oâ‚ƒ","CaO","MgO","Naâ‚‚O","Kâ‚‚O","SOâ‚ƒ","TiOâ‚‚"];

    let totalFlow = 0;
    let weightedGCV = 0;
    let weightedAFT = 0;

    for(let m = 0; m < 6; m++){
      const p1 = parseFloat( document.querySelector(`.percentage-input[data-row="1"][data-mill="${m}"]`)?.value ) || 0;
      const p2 = parseFloat( document.querySelector(`.percentage-input[data-row="2"][data-mill="${m}"]`)?.value ) || 0;
      const p3 = parseFloat( document.querySelector(`.percentage-input[data-row="3"][data-mill="${m}"]`)?.value ) || 0;

      const gcv1 = getValue(coal1, "GCV");
      const gcv2 = getValue(coal2, "GCV");
      const gcv3 = getValue(coal3, "GCV");

      const blendedGCV = (gcv1 * (p1/100)) + (gcv2 * (p2/100)) + (gcv3 * (p3/100));

      let ox = {};
      oxKeys.forEach(k => {
        ox[k] = (getValue(coal1, k) * (p1/100)) + (getValue(coal2, k) * (p2/100)) + (getValue(coal3, k) * (p3/100));
      });

      const aftVal = calcAFT(ox);

      const aftCell = document.querySelector(`.aft[data-mill="${m}"]`);
      if(aftCell) aftCell.innerText = isFinite(aftVal) ? Number(aftVal).toFixed(2) : "--";

      const flow = parseFloat( document.querySelector(`.flow-input[data-mill="${m}"]`)?.value ) || 0;

      if(flow > 0){
        totalFlow += flow;
        weightedGCV += (flow * blendedGCV);
        weightedAFT += (flow * aftVal);
      }
    }

    const avgGCV = totalFlow > 0 ? (weightedGCV / totalFlow) : 0;
    const avgAFT = totalFlow > 0 ? (weightedAFT / totalFlow) : 0;

    document.getElementById("totalFlow").innerText = Number(totalFlow).toFixed(2);
    document.getElementById("avgGCV").innerText = totalFlow>0 ? Number(avgGCV).toFixed(2) : 0;
    document.getElementById("avgAFT").innerText = totalFlow>0 ? Number(avgAFT).toFixed(2) : "--";

    const generation = parseFloat(document.getElementById("generation").value) || 0;
    if(generation > 0 && totalFlow > 0){
      const heatRate = (totalFlow * avgGCV) / generation;
      document.getElementById("heatRate").innerText = Number(heatRate).toFixed(2);
    } else {
      document.getElementById("heatRate").innerText = "--";
    }

function getCoalQty(rowIndex) {
  let total = 0;
  for (let m = 0; m < 6; m++) {
    const perc = parseFloat(document.querySelector(`.percentage-input[data-row="${rowIndex}"][data-mill="${m}"]`)?.value) || 0;
    total += perc; 
  }
  return total;
}


const cost1 = parseFloat(document.getElementById("costBox1").value) || 0;
const cost2 = parseFloat(document.getElementById("costBox2").value) || 0;
const cost3 = parseFloat(document.getElementById("costBox3").value) || 0;

const qty1 = getCoalQty(1);
const qty2 = getCoalQty(2);
const qty3 = getCoalQty(3);

const totalCost = (qty1 * cost1) + (qty2 * cost2) + (qty3 * cost3);
const totalQty  = qty1 + qty2 + qty3;
const costRate  = totalQty > 0 ? (totalCost / totalQty) : 0;

document.getElementById("COSTRATE").innerText = costRate.toFixed(2);


if(generation > 0 && totalFlow > 0){
  const heatRate = (totalFlow * avgGCV) / generation;
  document.getElementById("heatRate").innerText = Number(heatRate).toFixed(2);
} else {
  document.getElementById("heatRate").innerText = "--";
}

  }

  // new: validate sums and update header colors
  function validateMillPercentages() {
  for (let m = 0; m < 6; m++) {
    let hasPercent = false;

    // check if any percent input > 0 for this mill
    for (let r = 1; r <= 3; r++) {
      const val = parseFloat(
        document.querySelector(`.percentage-input[data-row="${r}"][data-mill="${m}"]`)?.value
      ) || 0;
      if (val > 0) {
        hasPercent = true;
        break;
      }
    }

    // check the coal flow for this mill
    const flow = parseFloat(
      document.querySelector(`.flow-input[data-mill="${m}"]`)?.value
    ) || 0;

    // find the mill header (MILL-A ... MILL-F)
    const letter = String.fromCharCode(65 + m); // A..F
    const header = Array.from(document.querySelectorAll(".mills-grid > .mill"))
      .find(el => el.textContent.includes(`MILL-${letter}`));

    if (!header) continue;

    // reset
    header.classList.remove("red", "green");

    if (hasPercent && flow > 0) {
      header.classList.add("red");
    } else {
      header.classList.add("green");
    }
  }
}

  function attachAutoUpdate(){
    // add focus + input handlers for percentage inputs to track previous value and validate
    document.querySelectorAll(".percentage-input").forEach(inp => {
      // store initial prev value
      inp.dataset.prev = inp.value || "";

      inp.addEventListener("focus", function(e){
        // store previous value before editing
        this.dataset.prev = this.value;
      });

      inp.addEventListener("input", function(e){
        // ensure only numeric and optionally decimal and limit accidental characters
        // allow empty (treat as 0)
        const raw = this.value.trim();
        // allow partial inputs like ".", so only parseFloat when needed
        let num = parseFloat(raw);
        if (raw === "" || isNaN(num)) num = 0;

        // compute new sum for this mill
        const millIndex = Number(this.dataset.mill);
        let sum = 0;
        for (let r = 1; r <=3; r++){
          const v = parseFloat(document.querySelector(`.percentage-input[data-row="${r}"][data-mill="${millIndex}"]`)?.value) || 0;
          sum += v;
        }

        if (sum > 100) {
          // revert to previous value and notify
          const prev = this.dataset.prev ?? "";
          this.value = prev;
          alert(`Total for Mill ${String.fromCharCode(65+millIndex)} cannot exceed 100%.`);
          // update blended calculations and header colors after revert
          calculateBlended();
          validateMillPercentages();
          return;
        }

        // valid, save as prev
        this.dataset.prev = this.value;
        // update calculations & visuals
        calculateBlended();
        validateMillPercentages();
      });
    });

    // existing inputs that affect calculation
    document.querySelectorAll(".flow-input, #generation, .cost-input").forEach(inp => {
      inp.addEventListener("input", () => { calculateBlended(); validateMillPercentages(); });
    });

    ["coalDrop1","coalDrop2","coalDrop3"].forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.addEventListener("change", () => { updateGCVCostBoxes(); calculateBlended(); validateMillPercentages(); });
    });

    // initial update
    updateGCVCostBoxes();
    calculateBlended();
    validateMillPercentages();
  }

  // allow the upload button to work like a label (no extra handler needed)
  document.querySelector(".upload-btn").addEventListener("click", ()=>{ /* no-op */ });

  attachAutoUpdate();

 document.getElementById("downloadPDF").addEventListener("click", function () {
  const { jsPDF } = window.jspdf;
  const element = document.body; // âœ… capture whole page including navbar

  html2canvas(element, {
    scale: 2,
    useCORS: true,
    onclone: (clonedDoc) => {
      // Handle input & textarea values
      const inputs = clonedDoc.querySelectorAll("input, textarea");
      inputs.forEach(input => {
        const text = clonedDoc.createElement("span");
        text.textContent = input.value;

        text.style.position = "absolute";
        text.style.left = input.offsetLeft + "px";
        text.style.top = input.offsetTop + "px";
        text.style.width = input.offsetWidth + "px";
        text.style.height = input.offsetHeight + "px";
        text.style.lineHeight = input.offsetHeight + "px";
        text.style.textAlign = "center";
        text.style.font = window.getComputedStyle(input).font;
        text.style.color = window.getComputedStyle(input).color;

        clonedDoc.body.appendChild(text);
        input.style.visibility = "hidden";
      });

      // Handle select dropdowns (coal names)
      const selects = clonedDoc.querySelectorAll("select");
      selects.forEach(select => {
        const selectedText = select.options[select.selectedIndex]?.text || "";
        const text = clonedDoc.createElement("span");
        text.textContent = selectedText;

        text.style.position = "absolute";
        text.style.left = select.offsetLeft + "px";
        text.style.top = select.offsetTop + "px";
        text.style.width = select.offsetWidth + "px";
        text.style.height = select.offsetHeight + "px";
        text.style.lineHeight = select.offsetHeight + "px";
        text.style.textAlign = "center";
        text.style.font = window.getComputedStyle(select).font;
        text.style.color = window.getComputedStyle(select).color;

        clonedDoc.body.appendChild(text);
        select.style.visibility = "hidden";
      });
    }
  }).then(canvas => {
    const imgData = canvas.toDataURL("image/png");
    const pdf = new jsPDF("p", "mm", "a4");

    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();

    const imgWidth = pageWidth;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;

    let heightLeft = imgHeight;
    let position = 0;

    pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
    heightLeft -= pageHeight;

    while (heightLeft > 0) {
      position = heightLeft - imgHeight;
      pdf.addPage();
      pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;
    }

    pdf.save("Coal_Blending_Ratio.pdf");
  });
});



</script>
</body>
</html>

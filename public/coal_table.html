<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Coal Data Table (No Horizontal Scroll)</title>

    <!-- SheetJS for Excel sheet -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <!-- jsPDF and html2canvas for PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- jsPDF AutoTable for proper table in PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* ----- base ----- */
        :root{
            --cell-max-width: 180px; /* tweak to control how much content is visible before ellipsis */
            --cell-padding: 8px;
            --accent: #02008a;
            --muted-border: #e5e7eb;
        }
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; font-size: 15px; }

        /* Navbar (left unchanged except smaller logo) */
        .navbar { display:flex; justify-content:space-between; align-items:center; background:#f7f8fa; padding:12px 18px; position:fixed; top:0; left:0; right:0; height:65px; z-index:1000; box-shadow:0 4px 8px rgba(0,0,0,0.06);} 
        .navbar img{ height:48px; }
        .navbar h1{ margin:0; font-size:18px; color:#111; }

        h1.page-title{ margin-top:84px; text-align:center; font-weight:600; }

        /* toolbar */
        .toolbar-wrapper{ display:flex; justify-content:center; margin-top:8px; }
        .toolbar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; max-width:1000px; padding: 6px 12px; }
        button{ padding:8px 12px; border-radius:8px; border:none; cursor:pointer; white-space:nowrap; }

        /* table area */
        .table-wrapper{
            margin:16px 16px 28px;
            /* Remove horizontal scrolling entirely */
            overflow-x: hidden;    /* <-- prevents horizontal scroll */
            overflow-y: auto;      /* keep vertical scrolling */
            max-height: calc(100vh - 220px);
            box-sizing: border-box;
            background: white;
            border-radius: 8px;
            border: 1px solid var(--muted-border);
            padding: 6px; 
            box-shadow: 0 6px 20px rgba(16,24,40,0.04);
        }

        /* make table responsive without horizontal scroll
           - fixed layout so columns share available width
           - width:100% so it never overflows wrapper
           - use ellipsis for overflow and show title tooltip for full text */
        table{
            width:100%;
            border-collapse:collapse;
            table-layout: fixed;   /* IMPORTANT: makes columns share space and prevents overflow */
            min-width: 0;          /* allow shrinking inside container */
        }

        thead th{
            position: relative;
            text-align:center;
            font-weight:700;
            padding: var(--cell-padding);
            font-size:13px;
            background:#fafafa;
            border-bottom:1px solid var(--muted-border);
            color:#111827;
        }

        th, td{
            border: 1px solid var(--muted-border);
            padding: var(--cell-padding);
            font-size:13px;
            vertical-align:middle;
            overflow: hidden;            /* hide overflow */
            text-overflow: ellipsis;     /* show ... */
            white-space: nowrap;         /* keep single line so ellipsis works */
            max-width: var(--cell-max-width);
        }

        /* allow specific columns to wrap (useable for names or long descriptive fields) */
        .col-wrap{ white-space: normal; word-break: break-word; }

        tbody tr:nth-child(even){ background: #fbfbfb; }
        tbody tr:hover{ background: #f1f5f9; }

        /* Sticky first column (select/id) so it remains visible when scrolling vertically */
        th:first-child, td:first-child{
            position: sticky;
            left: 0;
            background: linear-gradient(180deg,#ffffff,#ffffff);
            z-index: 3;
            box-shadow: 2px 0 6px rgba(0,0,0,0.04);
        }

        /* Keep header above everything (if sticky header is later desired) */
        thead th{ z-index: 2; }

        /* small adjustments for the `Select` checkbox column to keep it narrow */
        .col-checkbox{ width: 48px; min-width: 48px; max-width: 48px; text-align:center; }

        /* show full content on hover via tooltip appearance (using title attr from JS) */
        td:hover{ cursor: default; }

        /* mobile: smaller font and padding so more columns fit horizontally in the same space */
        @media (max-width: 800px){
            :root{ --cell-max-width: 120px; }
            th, td{ padding:6px; font-size:12px; }
        }
        @media (max-width: 480px){
            :root{ --cell-max-width: 90px; }
            h1.page-title{ font-size:16px; }
        }

    </style>
</head>
<body>
    <div class="navbar">
        <img src="/images/abhitech-logo.png" alt="Company Logo">
        <h1>Combustion Analyzer</h1>
        <div style="display:flex; gap:8px; align-items:center">
            <button onclick="window.location.href='model.html'">Model</button>
            <button onclick="window.location.href='slagging_coal_page.html'">Calculation</button>
            <button onclick="window.location.href='coal_blend_simulation.html'">Coal Blend</button>
            <button style="background:red; color:white; border-radius:20px; padding:8px 12px" onclick="logoutUser()">Logout</button>
        </div>
    </div>

    <h1 class="page-title">Slagging Data Table</h1>

    <div class="toolbar-wrapper">
        <div class="toolbar">
            <button onclick="downloadExcel()" style="background:linear-gradient(135deg,#22c55e,#16a34a); color:#fff">Download Template</button>
            <label for="fileInput" style="background:linear-gradient(135deg,#3b82f6,#2563eb); color:#fff; padding:8px 12px; border-radius:8px; cursor:pointer">üì§ Upload New Data</label>
            <input type="file" id="fileInput" accept=".xlsx, .xls" style="display:none">
            <button id="delete-selected-btn" style="background:linear-gradient(135deg,#ef4444,#dc2626); color:#fff">Delete Selected</button>
            <div class="download-dropdown">
                <button id="download-selected-btn" class="menu-btn" style="background:linear-gradient(135deg,#0ea5e9,#0284c7); color:#fff">Download Selected ‚ñæ</button>
                <div id="download-menu" class="dropdown-menu" aria-hidden="true" style="display:none; position:absolute; background:#fff; box-shadow:0 8px 20px rgba(0,0,0,0.12); padding:6px; border-radius:8px;">
                    <button type="button" onclick="downloadSelected('excel')">Download as Excel</button>
                    <button type="button" onclick="downloadSelected('pdf')">Download as PDF</button>
                </div>
            </div>
            <button id="downloadPDF" class="icon-btn" title="Download page as PDF">‚¨áÔ∏è</button>
        </div>
    </div>

    <div class="table-wrapper">
        <table id="data-table">
            <thead>
                <tr id="table-header"></tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>

    <script>
        const { jsPDF } = window.jspdf || {};

        if (localStorage.getItem('isLoggedIn') !== 'true'){
            // keep existing behaviour
            // alert('You must login first!'); window.location.href = '/login.html';
        }

        function logoutUser(){ localStorage.setItem('isLoggedIn','false'); window.location.href='login.html'; }
        function downloadExcel(){ window.location.href = '/download-template'; }

        document.addEventListener('DOMContentLoaded', ()=>{
            fetchData();
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
            document.getElementById('delete-selected-btn').addEventListener('click', handleDeleteSelected);
            document.getElementById('downloadPDF').addEventListener('click', handleDownloadPDF);
            setupDownloadDropdown();
        });

        function fetchData(){
            fetch('/fetch-data')
                .then(r=>r.json())
                .then(data=>displayTable(data))
                .catch(e=>console.error('fetch error', e));
        }

        // helper to check if header should be allowed to wrap (long names)
        function shouldWrapHeader(h){
            if(!h) return false;
            const s = String(h).toLowerCase();
            const wrapKeywords = ['coal', 'name', 'temperature', 'fusion', 'remark', 'description'];
            return wrapKeywords.some(k => s.includes(k));
        }

        function displayTable(data){
            const tableHeader = document.getElementById('table-header');
            const tableBody = document.getElementById('table-body');
            tableHeader.innerHTML = '';
            tableBody.innerHTML = '';
            if(!data || data.length === 0) return;

            // take keys from first object but keep order stable
            const headers = Object.keys(data[0]).filter(h => h !== '_id');
            headers.push('Select');

            // build header row
            headers.forEach(h => {
                const th = document.createElement('th');
                th.textContent = h;
                // add a class to allow wrapping for longer descriptive columns
                if(shouldWrapHeader(h) && h.toString().toLowerCase() !== 'select'){
                    th.classList.add('col-wrap');
                }
                // special case for select column
                if(h === 'Select') th.classList.add('col-checkbox');
                tableHeader.appendChild(th);
            });

            // body
            data.forEach(row => {
                const tr = document.createElement('tr');
                // all headers except last 'Select'
                headers.slice(0, -1).forEach(h => {
                    const td = document.createElement('td');
                    const val = row[h] !== undefined && row[h] !== null ? row[h] : '';
                    const text = String(val);
                    td.textContent = text;
                    // set full text as title so user can hover to see full value
                    td.title = text;
                    // if header should wrap, enable wrapping class on td (overrides nowrap)
                    if(shouldWrapHeader(h)) td.classList.add('col-wrap');
                    tr.appendChild(td);
                });

                // Select checkbox column (kept narrow)
                const checkboxTd = document.createElement('td');
                checkboxTd.classList.add('col-checkbox');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.setAttribute('data-id', row._id || '');
                try { checkbox.dataset.row = JSON.stringify(row); } catch(e){ checkbox.dataset.row = '{}'; }
                checkboxTd.appendChild(checkbox);
                tr.appendChild(checkboxTd);

                tableBody.appendChild(tr);
            });
        }

        function handleFileUpload(e){
            const file = e.target.files[0]; if(!file) return;
            const fd = new FormData(); fd.append('file', file);
            fetch('/upload-excel', { method:'POST', body: fd })
                .then(r=>r.json())
                .then(data=>{ alert('Uploaded'); fetchData(); })
                .catch(err=>console.error(err));
        }

        function handleDeleteSelected(){
            const boxes = document.querySelectorAll('input[type="checkbox"]:checked');
            if(boxes.length === 0){ alert('Please select at least one row to delete.'); return; }
            if(!confirm('Delete selected rows?')) return;
            const ids = Array.from(boxes).map(cb => cb.getAttribute('data-id'));
            fetch('/delete-data', { method:'DELETE', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ids}) })
                .then(r=>r.json())
                .then(resp=>{ alert(resp.message || 'Deleted'); fetchData(); })
                .catch(err=>console.error(err));
        }

        function setupDownloadDropdown(){
            const downloadBtn = document.getElementById('download-selected-btn');
            const menu = document.getElementById('download-menu');
            if(!downloadBtn || !menu) return;
            downloadBtn.addEventListener('click', e=>{ e.stopPropagation(); menu.style.display = (menu.style.display==='block') ? 'none' : 'block'; });
            document.addEventListener('click', (e)=>{ if(!menu.contains(e.target) && e.target !== downloadBtn){ menu.style.display = 'none'; } });
        }

        async function downloadSelected(format){
            const boxes = document.querySelectorAll('input[type="checkbox"]:checked');
            if(boxes.length === 0){ alert('Please select at least one row to download.'); return; }
            const rows = Array.from(boxes).map(cb => { try { return JSON.parse(cb.dataset.row || '{}'); } catch(e) { return {}; } });
            const keys = Object.keys(rows[0] || {}).filter(k => k !== '_id');

            if(format === 'excel'){
                const jsonData = rows.map(r=>{ const o={}; keys.forEach(k=>o[k]=r[k]!==undefined?r[k]:'' ); return o; });
                const ws = XLSX.utils.json_to_sheet(jsonData);
                const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Selected'); XLSX.writeFile(wb, 'selected_rows.xlsx'); return;
            }
            if(format === 'pdf'){
                // basic PDF creation (keeps behaviour from original file)
                const doc = new jsPDF('l', 'mm', 'a4');
                const head = [keys.map(k => k)];
                const body = rows.map(r => keys.map(k => r[k]));
                doc.autoTable({ head, body, startY: 10, styles:{ fontSize:8, cellPadding:2 }, margin:{left:8, right:8}, tableWidth:'auto'});
                doc.save('selected_rows.pdf');
                return;
            }
            alert('Unsupported format: ' + format);
        }

        function handleDownloadPDF(){
            // similar to original behaviour: capture page and save
            const element = document.body;
            html2canvas(element, { scale:2, useCORS:true }).then(canvas=>{
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgData = canvas.toDataURL('image/png');
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const imgWidth = pageWidth;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight; let position = 0;
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                while(heightLeft > 0){ position = heightLeft - imgHeight; pdf.addPage(); pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight); heightLeft -= pageHeight; }
                pdf.save('Coal_Blending_Ratio.pdf');
            });
        }
    </script>
</body>
</html>

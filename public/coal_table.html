<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coal Data Table</title>

    <!-- Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

    <!-- jsPDF + html2canvas for PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            font-size: large;
            font-family: Arial, sans-serif;
        }

        /* Navbar Styling */
        .navbar {
            display: flex;
            justify-content: space-between;
            width: 100%;
            background-color: #f7f8fa;
            align-items: center;
            padding: 15px 20px;
            color: white;
            position: fixed;
            top: 0;
            left: 0;
            height: 65px;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .navbar img {
            height: 95px;
            margin-right: 10px;
            margin-left: 0px;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            margin-right: 20px;
        }

        .navbar button {
            padding: 10px 15px;
            background-color: #02008a;
            color: #ffffff;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            margin-right: 20px;
            font-weight: bold;
        }

        .navbar button:hover {
            background-color: #001cbb;
        }

        .navbar h1 {
            margin-left: 0px;
            font-size: 20px;
            color: black;
        }

        .navbar .logout-btn {
            padding: 10px 16px;
            background-color: red !important;
            color: #fff !important;
            border: none;
            cursor: pointer;
            border-radius: 25px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .navbar .logout-btn:hover {
            background-color: darkred !important;
        }

        /* Heading below navbar */
        h1.page-title {
            margin-top: 90px;
            text-align: center;
        }

        /* CENTERED TOOLBAR UNDER HEADING */
        .toolbar-wrapper {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }

        .toolbar {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
            max-width: 900px;
            padding: 0 16px;
        }

        /* Base Button Styling */
        button {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 8px rgba(0,0,0,0.12);
            white-space: nowrap;
        }
        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 12px rgba(0,0,0,0.18);
        }

        /* Download Template */
        .btn-template {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: #fff;
        }

        /* Upload new data (label styled as button) */
        .btn-upload {
            display: inline-flex;
            align-items: center;
            gap: 8px;

            padding: 10px 16px;
            border-radius: 8px;
            border: none;

            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;

            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: #ffffff;
            box-shadow: 0 3px 8px rgba(0,0,0,0.12);
            transition: all 0.2s ease;
            text-decoration: none;
        }
        .btn-upload:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 12px rgba(0,0,0,0.18);
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
        }

        /* Hide actual file input */
        #fileInput {
            display: none;
        }

        /* Delete Selected button */
        #delete-selected-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: #fff;
        }
        #delete-selected-btn:hover {
            background: #b91c1c;
        }

        /* Download Selected dropdown */
        .download-dropdown {
            position: relative;
            display: inline-block;
        }
        .download-dropdown .menu-btn {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            color: #fff;
        }
        .download-dropdown .dropdown-menu {
            position: absolute;
            top: calc(100% + 6px);
            left: 0;
            display: none;
            background: white;
            min-width: 170px;
            border-radius: 8px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.16);
            z-index: 2000;
            padding: 6px;
        }
        .download-dropdown .dropdown-menu button {
            display: block;
            width: 100%;
            text-align: left;
            padding: 8px 10px;
            background: transparent;
            border-radius: 6px;
            margin: 0;
            box-shadow: none;
            font-size: 14px;
            font-weight: 600;
        }
        .download-dropdown .dropdown-menu button:hover {
            background: #f3f4f6;
            transform: none;
        }

        /* Download PDF icon button */
        #downloadPDF.icon-btn {
            background: #02008a;
            color: #fff;
            border-radius: 50%;
            padding: 10px 12px;
            font-size: 18px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.12);
            position: relative;
        }

        /* Tooltip for PDF icon */
        .icon-btn::after {
            content: attr(title);
            position: absolute;
            bottom: -35px;
            left: 50%;
            transform: translateX(-50%);
            background: #000;
            color: #fff;
            font-size: 12px;
            padding: 5px 8px;
            border-radius: 6px;
            opacity: 0;
            white-space: nowrap;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .icon-btn:hover::after {
            opacity: 1;
        }

        /* Table wrapper under toolbar */
        .table-wrapper {
            margin-top: 20px;
            padding: 0 16px 16px;
            overflow: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        th, td {
            border: 1px solid black;
            padding: 8px;
            min-width: 100px;
            text-align: center;
        }

        th {
            background-color: #f4f4f4;
            min-height: 20px;
        }

        th:first-child, td:first-child {
            position: sticky;
            left: 0;
            border: 1px solid black;
            background-color: white;
            z-index: 2;
        }
    </style>

    <script>
        // Auth check
        if (localStorage.getItem('isLoggedIn') !== 'true') {
            alert('You must login first!');
            window.location.href = '/login.html';
        } else {
            document.body.style.display = 'block';
        }

        function logoutUser() {
            localStorage.setItem('isLoggedIn', 'false');
            window.location.href = 'login.html';
        }
    </script>
</head>
<body>

<div class="navbar">
    <img src="/images/abhitech-logo.png" alt="Company Logo">
    <h1>Combustion Analyzer</h1>
    <div class="nav-buttons">
        <button onclick="window.location.href='model.html'">Model</button>
        <button onclick="window.location.href='slagging_coal_page.html'">Calculation</button>
        <button onclick="window.location.href='coal_blend_simulation.html'">Coal Blend Simulation</button>
        <button class="logout-btn" onclick="logoutUser()">Logout</button>
    </div>
</div>

<h1 class="page-title">Slagging Data Table</h1>

<!-- CENTERED TOOLBAR -->
<div class="toolbar-wrapper">
    <div class="toolbar">
        <button class="btn-template" onclick="downloadExcel()">Download Template</button>

        <label for="fileInput" class="btn-upload">
            üì§ Upload New Data
        </label>
        <input type="file" id="fileInput" accept=".xlsx, .xls">

        <button id="delete-selected-btn">Delete Selected</button>

        <!-- Download Selected dropdown -->
        <div class="download-dropdown">
            <button id="download-selected-btn" class="menu-btn">
                Download Selected ‚ñæ
            </button>
            <div id="download-menu" class="dropdown-menu" aria-hidden="true">
                <button type="button" onclick="downloadSelected('excel')">Download as Excel</button>
                <button type="button" onclick="downloadSelected('pdf')">Download as PDF</button>
            </div>
        </div>

        <button id="downloadPDF" class="icon-btn" title="Download page as PDF">‚¨áÔ∏è</button>
    </div>
</div>

<div class="table-wrapper">
    <table id="data-table">
        <thead>
            <tr id="table-header"></tr>
        </thead>
        <tbody id="table-body"></tbody>
    </table>
</div>

<script>
    const { jsPDF } = window.jspdf;

    // for selected-rows PDF header logo
    let pdfLogoDataUrl = null;
    let pdfLogoAspect = 0; // height / width

    function downloadExcel() {
        window.location.href = "/download-template";
    }

    document.addEventListener("DOMContentLoaded", () => {
        fetchData();
        loadPdfLogo();

        document.getElementById("fileInput").addEventListener("change", handleFileUpload);
        document.getElementById("delete-selected-btn").addEventListener("click", handleDeleteSelected);
        document.getElementById("downloadPDF").addEventListener("click", handleDownloadPDF);

        setupDownloadDropdown();
    });

    function fetchData() {
        fetch("/fetch-data")
            .then(response => response.json())
            .then(data => displayTable(data))
            .catch(error => console.error("Error fetching data:", error));
    }

    function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append("file", file);

        fetch("/upload-excel", {
            method: "POST",
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            alert("File uploaded successfully!");
            window.location.reload();
            displayTable(data);
        })
        .catch(error => console.error("Error uploading file:", error));
    }

    function displayTable(data) {
        const tableHeader = document.getElementById("table-header");
        const tableBody = document.getElementById("table-body");
        tableHeader.innerHTML = "";
        tableBody.innerHTML = "";

        if (!data || data.length === 0) return;

        const headers = Object.keys(data[0]).filter(header => header !== '_id');
        headers.push("Select");

        // Header row
        headers.forEach((header) => {
            let th = document.createElement("th");
            th.textContent = header;
            tableHeader.appendChild(th);
        });

        // Body rows
        data.forEach(row => {
            let tr = document.createElement("tr");

            headers.slice(0, -1).forEach((header) => {
                let td = document.createElement("td");
                td.textContent = row[header] !== undefined ? row[header] : "";
                tr.appendChild(td);
            });

            // Checkbox for Select
            let checkboxTd = document.createElement("td");
            let checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.setAttribute("data-id", row._id);
            // store row data for downloadSelected
            try {
                checkbox.dataset.row = JSON.stringify(row);
            } catch (e) {
                checkbox.dataset.row = "{}";
            }
            checkboxTd.appendChild(checkbox);
            tr.appendChild(checkboxTd);

            tableBody.appendChild(tr);
        });
    }

    function handleDeleteSelected() {
        const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
        if (checkboxes.length === 0) {
            alert("Please select at least one row to delete.");
            return;
        }

        if (!confirm("Are you sure you want to delete the selected data?")) return;

        const ids = Array.from(checkboxes).map(checkbox => checkbox.getAttribute("data-id"));

        fetch("/delete-data", {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ ids: ids })
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            fetchData();
        })
        .catch(error => console.error("Error deleting data:", error));
    }

    // Load logo into base64 for PDF header (correct aspect ratio)
    function loadPdfLogo() {
        const img = new Image();
        img.src = "/images/abhitech-logo.png";
        img.crossOrigin = "anonymous";

        img.onload = function () {
            const canvas = document.createElement("canvas");
            canvas.width = img.width;
            canvas.height = img.height;

            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

            pdfLogoDataUrl = canvas.toDataURL("image/png");
            if (img.width) {
                pdfLogoAspect = img.height / img.width;
            }
        };

        img.onerror = function () {
            console.warn("Could not load logo for PDF header");
            pdfLogoDataUrl = null;
        };
    }

    // Clean up text for PDF (fix oxide names)
    function normalizeText(text) {
        if (text === undefined || text === null) return "";
        let t = String(text);

        // replace subscript digits with normal digits
        const subMap = {
            '‚ÇÄ':'0','‚ÇÅ':'1','‚ÇÇ':'2','‚ÇÉ':'3','‚ÇÑ':'4',
            '‚ÇÖ':'5','‚ÇÜ':'6','‚Çá':'7','‚Çà':'8','‚Çâ':'9'
        };
        t = t.replace(/[‚ÇÄ-‚Çâ]/g, ch => subMap[ch] || '');

        // fix some odd characters we've seen
        t = t
            .replace(/∆í/g, 'f')
            .replace(/‚Äö/g, ',')
            .replace(/‚Äû/g, '"')
            .replace(/‚Ä¶/g, '...')
            .replace(/‚àí/g, '-');

        // collapse multiple whitespace
        t = t.replace(/\s+/g, ' ').trim();

        // join split single-letter tokens: "S i O" -> "SiO"
        t = t.replace(/(\b[A-Za-z])\s(?=[A-Za-z]\b)/g, '$1');

        return t;
    }

    // Dropdown behaviour for "Download Selected"
    function setupDownloadDropdown() {
        const downloadBtn = document.getElementById("download-selected-btn");
        const downloadMenu = document.getElementById("download-menu");
        if (!downloadBtn || !downloadMenu) return;

        downloadBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            const visible = downloadMenu.style.display === "block";
            downloadMenu.style.display = visible ? "none" : "block";
            downloadMenu.setAttribute("aria-hidden", visible ? "true" : "false");
        });

        document.addEventListener("click", (e) => {
            if (!downloadMenu.contains(e.target) && e.target !== downloadBtn) {
                downloadMenu.style.display = "none";
                downloadMenu.setAttribute("aria-hidden", "true");
            }
        });
    }

    // Download selected rows as Excel or PDF (with dynamic header spacing and text normalization)
    async function downloadSelected(format) {
        const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
        if (checkboxes.length === 0) {
            alert("Please select at least one row to download.");
            return;
        }

        const rows = Array.from(checkboxes).map(cb => {
            try {
                return JSON.parse(cb.dataset.row || "{}");
            } catch (e) {
                return {};
            }
        });

        const downloadMenu = document.getElementById("download-menu");
        if (downloadMenu) downloadMenu.style.display = "none";

        const keys = Object.keys(rows[0] || {}).filter(k => k !== "_id");

        /* ---------------------- EXCEL DOWNLOAD ---------------------- */
        if (format === "excel") {
            const jsonData = rows.map(r => {
                const obj = {};
                keys.forEach(k => obj[k] = r[k] !== undefined ? r[k] : "");
                return obj;
            });
            const ws = XLSX.utils.json_to_sheet(jsonData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Selected");
            XLSX.writeFile(wb, "selected_rows.xlsx");
            return;
        }

        /* ---------------------- PDF DOWNLOAD ---------------------- */
        if (format === "pdf") {
            const doc = new jsPDF("l", "mm", "a4");
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();

            const headerBarHeight = 20;          // slightly taller bar
            const marginX = 10;
            const marginY = headerBarHeight + 8; // more space before table
            const lineHeight = 4;
            const usableWidth = pageWidth - 2 * marginX;
            const colWidth = usableWidth / keys.length;

            doc.setFontSize(8);
            doc.setFont(undefined, "normal");

            /* ------ BLUE HEADER + LOGO (SHRUNK, NOT STRETCHED) ------ */
            function drawPdfHeader() {
                doc.setFillColor(2, 0, 138);
                doc.rect(0, 0, pageWidth, headerBarHeight, "F");

                let logoRightX = 5;

                if (pdfLogoDataUrl) {
                    // keep logo inside bar with padding
                    const maxLogoHeight = headerBarHeight - 4; // vertical padding
                    let logoH = Math.min(maxLogoHeight, 12);    // cap absolute size
                    let logoW = logoH;

                    if (pdfLogoAspect && pdfLogoAspect > 0) {
                        // aspect = h / w  =>  w = h / aspect
                        logoW = logoH / pdfLogoAspect;
                    }

                    const yPos = (headerBarHeight - logoH) / 2;
                    const xPos = 6; // small left margin

                    doc.addImage(pdfLogoDataUrl, "PNG", xPos, yPos, logoW, logoH);
                    logoRightX = xPos + logoW;
                }

                doc.setTextColor(255, 255, 255);
                doc.setFontSize(12);
                doc.setFont(undefined, "bold");
                doc.text("Combustion Analyzer", logoRightX + 6, headerBarHeight / 2 + 3);

                doc.setFontSize(10);
                doc.text(
                    "Slagging Data Table - Selected Rows",
                    pageWidth / 2,
                    headerBarHeight / 2 + 3,
                    { align: "center" }
                );

                doc.setTextColor(0, 0, 0);
                doc.setFontSize(8);
                doc.setFont(undefined, "normal");
            }

            let y = marginY;

            /* ------ DYNAMIC HEADER ROW HEIGHT + CLEAN TEXT ------ */
            function drawHeaderRow() {
                doc.setFont(undefined, "bold");

                let maxHeaderLines = 1;

                keys.forEach((h, index) => {
                    const headerText = normalizeText(h);
                    const x = marginX + index * colWidth;
                    const headerLines = doc.splitTextToSize(headerText, colWidth - 2);

                    if (headerLines.length > maxHeaderLines) {
                        maxHeaderLines = headerLines.length;
                    }

                    let lineY = y;
                    headerLines.forEach(line => {
                        doc.text(line, x, lineY);
                        lineY += lineHeight;
                    });
                });

                doc.setFont(undefined, "normal");

                // Full header height + a little extra gap
                y += maxHeaderLines * lineHeight + 4;
            }

            function addNewPage() {
                doc.addPage();
                drawPdfHeader();
                y = marginY;
                drawHeaderRow();
            }

            drawPdfHeader();
            drawHeaderRow();

            /* ------ BODY ROWS (with clean text) ------ */
            rows.forEach((row) => {
                const cellData = keys.map((k, index) => {
                    const value = normalizeText(row[k]);
                    const x = marginX + index * colWidth;
                    const lines = doc.splitTextToSize(value, colWidth - 2);
                    return { x, lines };
                });

                const maxLines = Math.max(...cellData.map(c => c.lines.length || 1));
                const rowHeight = maxLines * lineHeight + 1;

                if (y + rowHeight > pageHeight - 10) {
                    addNewPage();
                }

                cellData.forEach(cell => {
                    let lineY = y;
                    cell.lines.forEach(line => {
                        doc.text(line, cell.x, lineY);
                        lineY += lineHeight;
                    });
                });

                y += rowHeight;
            });

            doc.save("selected_rows.pdf");
            return;
        }

        /* ---------------------- FALLBACK ---------------------- */
        alert("Unsupported download format: " + format);
    }

    // Full page PDF (with real navbar & logo via html2canvas)
    function handleDownloadPDF() {
        const element = document.body;

        // ensure navbar is in view
        window.scrollTo(0, 0);

        html2canvas(element, {
            scale: 2,
            useCORS: true,
            scrollY: -window.scrollY,
            onclone: (clonedDoc) => {
                // Render input values as text
                const inputs = clonedDoc.querySelectorAll("input, textarea");
                inputs.forEach(input => {
                    const text = clonedDoc.createElement("span");
                    text.textContent = input.value;

                    text.style.position = "absolute";
                    text.style.left = input.offsetLeft + "px";
                    text.style.top = input.offsetTop + "px";
                    text.style.width = input.offsetWidth + "px";
                    text.style.height = input.offsetHeight + "px";
                    text.style.lineHeight = input.offsetHeight + "px";
                    text.style.textAlign = "center";
                    text.style.font = window.getComputedStyle(input).font;
                    text.style.color = window.getComputedStyle(input).color;

                    clonedDoc.body.appendChild(text);
                    input.style.visibility = "hidden";
                });

                // Render selects as text (if any)
                const selects = clonedDoc.querySelectorAll("select");
                selects.forEach(select => {
                    const selectedText = select.options[select.selectedIndex]?.text || "";
                    const text = clonedDoc.createElement("span");
                    text.textContent = selectedText;

                    text.style.position = "absolute";
                    text.style.left = select.offsetLeft + "px";
                    text.style.top = select.offsetTop + "px";
                    text.style.width = select.offsetWidth + "px";
                    text.style.height = select.offsetHeight + "px";
                    text.style.lineHeight = select.offsetHeight + "px";
                    text.style.textAlign = "center";
                    text.style.font = window.getComputedStyle(select).font;
                    text.style.color = window.getComputedStyle(select).color;

                    clonedDoc.body.appendChild(text);
                    select.style.visibility = "hidden";
                });
            }
        }).then(canvas => {
            const pdf = new jsPDF("p", "mm", "a4");
            const imgData = canvas.toDataURL("image/png");

            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();

            const imgWidth = pageWidth;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;

            let heightLeft = imgHeight;
            let position = 0;

            pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;

            while (heightLeft > 0) {
                position = heightLeft - imgHeight;
                pdf.addPage();
                pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
            }

            pdf.save("Coal_Blending_Ratio.pdf");
        });
    }
</script>
</body>
</html>

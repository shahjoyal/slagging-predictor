<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Abhitech Energycon Limited</title>
    <link rel="icon" href="images/abhitech-logo.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --primary-1: #0b3bff;
            --primary-2: #02008a;
        }
        body { margin:0; padding:0; font-family: Arial, sans-serif; font-size:14px; color:#111827; }
        .navbar{ position:fixed; top:0; left:0; right:0; height:72px; padding:10px 22px; display:flex; align-items:center; justify-content:space-between; background: linear-gradient(180deg, rgba(255,255,255,0.92), rgba(250,251,255,0.86)); box-shadow:0 10px 30px rgba(9,20,46,0.06); z-index:1100; }
        .navbar img{ height:46px; object-fit:contain; margin-right:12px; }
        .navbar h1{ font-weight:700; font-size:18px; color:var(--primary-2); margin:0 14px; }
        .nav-buttons{ display:flex; gap:10px; align-items:center; }
        .nav-buttons button{ padding:8px 14px; border-radius:999px; border:none; font-weight:600; cursor:pointer; background: linear-gradient(180deg,var(--primary-1),var(--primary-2)); color:#fff; }
        .nav-buttons .logout-btn{ background: linear-gradient(180deg,#ff4b4b,#e32d2d); }

        h1.page-title { margin-top:100px; text-align:center; font-size:20px; }

        .toolbar-wrapper { margin-top: 18px; padding: 0 16px; display:flex; justify-content:center; }
        .toolbar { width:100%; max-width:1100px; display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }

        .left-group, .right-group { display:flex; gap:5px; align-items:center; }

        button { padding: 10px 14px; border-radius:8px; border:none; cursor:pointer; font-weight:600; box-shadow:0 3px 8px rgba(0,0,0,0.08); transition:all .12s; background:#e5e7eb; }
        button:disabled { opacity:0.5; cursor:not-allowed; transform:none; box-shadow:none; }

        .btn-template { background: linear-gradient(135deg, #22c55e, #16a34a); color:#fff; }
        .btn-upload { background: linear-gradient(135deg, #3b82f6, #2563eb); color:#fff; }
        .btn-delete { background: linear-gradient(135deg, #ef4444, #dc2626); color:#fff; }
        .btn-download { background: linear-gradient(135deg,#0ea5e9,#0284c7); color:#fff; }

        .table-wrapper { margin: 16px; padding: 12px; border-radius:10px; overflow-x:auto; background: linear-gradient(180deg, rgba(2,0,138,0.02), transparent 40%); }
        table { width:100%; border-collapse:collapse; min-width:900px; background:white; border-radius:8px; overflow:hidden; box-shadow:0 4px 18px rgba(2,6,23,0.04); }
        thead th { background-color: var(--primary-2); color:#fff; padding:12px 10px; text-align:center; font-weight:700; white-space:nowrap; }
        tbody td { padding:10px 12px; text-align:center; border-bottom:1px solid #eef2f7; }
        tbody tr:nth-child(even){ background:#fbfdff; }
        tbody tr:hover{ background:#f1f5f9; }

        /* Keep first column sticky (Coal ID) */
         tbody td:first-child {
            position: sticky;
            left: 0;
            background: linear-gradient(90deg,#ffffff,#ffffff);
            z-index:3;
            box-shadow: 2px 0 6px rgba(0,0,0,0.04);
            font-weight:700;
        }

        /* make checkbox column narrower */
        thead th:last-child, tbody td:last-child { width:86px; min-width:86px; max-width:130px; }

        @media (max-width:900px) {
            table { min-width:760px; font-size:13px; }
            .toolbar { padding:0 8px; }
        }

        #fileInput { display:none; }
        .download-dropdown { position:relative; }
        .download-dropdown .dropdown-menu { position:absolute; top: calc(100% + 6px); left:0; display:none; background:#fff; padding:6px; border-radius:8px; box-shadow:0 8px 20px rgba(0,0,0,0.12); z-index:2000; min-width:170px; }
        .download-dropdown .dropdown-menu button { display:block; width:100%; text-align:left; background:transparent; border-radius:6px; padding:8px 10px; }
     /* keep toolbar centered but make groups hug ends of it */
.toolbar { display:flex; justify-content:space-between; align-items:center; width:100%; max-width:1100px; }

/* left stays left, right will push to the far right of the toolbar */
.left-group { margin-right: 0; } /* optional */
.right-group { margin-left: auto; }
/* make toolbar span page width (minus wrapper padding) */
.toolbar-wrapper { display:flex; justify-content:center; padding: 0 16px; } /* keep wrapper */
.toolbar {
    display:flex;
    justify-content:space-between;
    align-items:center;
    width: calc(100% - 32px); /* full width minus wrapper padding */
    max-width: none;          /* remove the 1100px cap */
}

/* groups behave normally inside a full-width toolbar */
.left-group, .right-group { display:flex; align-items:center; gap:8px; }

   
   </style>
</head>
<body>
    <!-- <div class="navbar">
        <div style="display:flex; align-items:center;">
            <img src="/images/abhitech-logo.png" alt="Company Logo">
            <h1>Combustion Analyzer</h1>
        </div>
        <div class="nav-buttons">
            <button onclick="window.location.href='model.html'">Model</button>
            <button onclick="window.location.href='slagging_coal_page.html'">Calculation</button>
            <button class="logout-btn" onclick="logoutUser()">Logout</button>
        </div>
    </div> -->

    <h1 class="page-title">Slagging Data Table</h1>

    <div class="toolbar-wrapper">
        <div class="toolbar">
            <div class="left-group">
                <button class="btn-template" id="btn-download-template">Download Template</button>

                <!-- Replaced label with a proper button to fix UI -->
                <button id="btn-upload" class="btn-upload" type="button">ðŸ“¤ Upload New Data</button>
                <input type="file" id="fileInput" accept=".xlsx,.xls">

            </div>

            <div class="right-group">
                <div class="download-dropdown">
                    <button id="download-selected-btn" class="btn-download" disabled>Download Selected â–¾</button>
                    <div id="download-menu" class="dropdown-menu" aria-hidden="true">
                        <button type="button" onclick="downloadSelected('excel')">Download as Excel</button>
                        <button type="button" onclick="downloadSelected('pdf')">Download as PDF</button>
                    </div>
                </div>

                <button id="delete-selected-btn" class="btn-delete" disabled>Delete Selected</button>

                <button id="downloadWholePDFBtn" class="btn-download">Download whole page as PDF</button>
            </div>
        </div>
    </div>

    <div class="table-wrapper">
        <table id="data-table" role="table" aria-label="coal data table">
            <thead>
                <tr id="table-header"></tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>

<script>
    // Simple auth check (kept)
    if (localStorage.getItem('isLoggedIn') !== 'true') {
        alert('You must login first!');
        window.location.href = '/login.html';
    }

    // ---------- helpers ----------
    function formatCellValue(value) {
        if (value === null || value === undefined) return "";
        if (typeof value === "number" && isFinite(value)) return value.toFixed(2);
        if (typeof value === "string") {
            const t = value.trim();
            if (t === "") return "";
            const n = Number(t.replace(/,/g,''));
            if (!isNaN(n) && isFinite(n)) return n.toFixed(2);
            return value;
        }
        try { return JSON.stringify(value); } catch(e) { return String(value); }
    }

    // ---------- fetch and render ----------
    function fetchData() {
        fetch("/fetch-data")
            .then(r => r.json())
            .then(data => displayTable(data))
            .catch(err => console.error("fetch error", err));
    }

    function displayTable(data) {
        const headerRow = document.getElementById('table-header');
        const tbody = document.getElementById('table-body');
        headerRow.innerHTML = ''; tbody.innerHTML = '';

        if (!data || data.length === 0) {
            headerRow.innerHTML = '<th>No data</th>';
            return;
        }

        // Compute header keys: ensure Coal ID first then other keys (excluding _id)
        // We'll inspect all rows to build a stable header order
        const keySet = new Set();
        data.forEach(d => Object.keys(d).forEach(k => keySet.add(k)));
        // We prefer the following order: coalId (if present) or _id as "Coal ID", then coal/name, other known fields, then rest
        const preferred = ['coalId','_id','coal','Coal','name','SiO2','Al2O3','Fe2O3','CaO','MgO','Na2O','K2O','TiO2','SO3','P2O5','Mn3O4','Sulphur','GCV','cost','Transport ID','shipmentDate'];
        const keys = [];

        // Add Coal ID column as "Coal ID"
        keys.push('Coal ID');

        // Build the rest: include known preferred fields if present
        preferred.forEach(p => {
            if (keySet.has(p) && !['coalId','_id'].includes(p) && p !== 'Coal ID') {
                if (!keys.includes(p)) keys.push(p);
                keySet.delete(p);
            }
            if (keySet.has(p) && ['coalId','_id'].includes(p)) {
                // these were consumed by "Coal ID" column already
                keySet.delete(p);
            }
        });

        // remaining keys (exclude internal __v)
        Array.from(keySet).filter(k => k !== '__v').forEach(k => keys.push(k));

        // final column is Select
        keys.push('Select');

        // build header cells
        keys.forEach(k => {
            const th = document.createElement('th');
            th.textContent = k;
            headerRow.appendChild(th);
        });

        // Helper: get coalId value from row
        function getCoalIdFromRow(r) {
            if (r.coalId) return String(r.coalId);
            if (r['Coal ID']) return String(r['Coal ID']);
            if (r._id) return String(r._id);
            return '';
        }

        // render rows
        data.forEach(row => {
            const tr = document.createElement('tr');

            // Coal ID first
            const coalIdVal = getCoalIdFromRow(row);
            const tdId = document.createElement('td');
            tdId.textContent = coalIdVal;
            tr.appendChild(tdId);

            // other keys: iterate over header keys starting from second index up to last-1 (skip Select)
            // reconstruct the same order used for headers (except Coal ID and Select)
            const headerKeys = Array.from(headerRow.children).map(th => th.textContent);
            for (let i = 1; i < headerKeys.length - 1; i++) {
                const key = headerKeys[i];
                // For keys like 'Transport ID' or 'shipmentDate' we just use the property if exists
                let raw = row[key] !== undefined ? row[key] : (row[key.replace(/\s+/g,'')] !== undefined ? row[key.replace(/\s+/g,'')] : "");
                // If header equals some canonical internal names, try alternate names
                if ((key === 'coal' || key === 'Coal' || key === 'name') && !raw) raw = row.coal || row.name || row['Coal'];
                if ((key === 'GCV' || key === 'gcv') && raw === undefined) raw = row.GCV || row.gcv;
                const td = document.createElement('td');
                td.textContent = formatCellValue(raw);
                tr.appendChild(td);
            }

            // checkbox column
            const cbTd = document.createElement('td');
            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.setAttribute('data-id', row._id ? String(row._id) : getCoalIdFromRow(row));
            // store original row (stringified). Use safe fallback.
            try { cb.dataset.row = JSON.stringify(row); } catch(e) { cb.dataset.row = "{}"; }
            cb.addEventListener('change', updateSelectionButtons);
            cbTd.appendChild(cb);
            tr.appendChild(cbTd);

            tbody.appendChild(tr);
        });

        // after rendering reset buttons state
        updateSelectionButtons();
    }

    // ---------- file upload ----------
    // trigger hidden file input when upload button is clicked
    document.getElementById('btn-upload').addEventListener('click', function() {
        const fi = document.getElementById('fileInput');
        if (fi) fi.click();
    });

    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const fd = new FormData();
        fd.append('file', file);

        fetch('/upload-excel', { method:'POST', body: fd })
            .then(r => r.json())
            .then(data => {
                alert(data.message || 'Upload finished');
                fetchData();
            })
            .catch(err => {
                console.error('upload err', err);
                alert('Upload failed');
            })
            .finally(() => { e.target.value = ''; });
    });

    // ---------- download template ----------
    document.getElementById('btn-download-template').addEventListener('click', function(){
        // includeData = false
        window.location.href = "/download-template";
    });

    // ---------- selection / button enable logic ----------
    function updateSelectionButtons() {
        const checked = document.querySelectorAll('input[type="checkbox"]:checked');
        const deleteBtn = document.getElementById('delete-selected-btn');
        const downloadBtn = document.getElementById('download-selected-btn');

        const any = checked.length > 0;
        deleteBtn.disabled = !any;
        downloadBtn.disabled = !any;
    }

    document.getElementById('delete-selected-btn').addEventListener('click', function(){
        const checked = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'));
        if (checked.length === 0) { alert('Select rows first'); return; }
        if (!confirm('Are you sure you want to delete selected rows?')) return;
        const ids = checked.map(cb => cb.getAttribute('data-id')).filter(Boolean);

        fetch('/delete-data', {
            method:'DELETE',
            headers: { 'Content-Type':'application/json' },
            body: JSON.stringify({ ids })
        })
        .then(r => r.json())
        .then(resp => {
            alert(resp.message || 'Deleted');
            fetchData();
        })
        .catch(err => { console.error(err); alert('Delete failed'); });
    });

    // download dropdown toggle
    function setupDownloadDropdown() {
        const downloadBtn = document.getElementById('download-selected-btn');
        const menu = document.getElementById('download-menu');
        if (!downloadBtn || !menu) return;
        downloadBtn.addEventListener('click', function(e){
            e.stopPropagation();
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
            menu.setAttribute('aria-hidden', menu.style.display === 'block' ? 'false' : 'true');
        });
        document.addEventListener('click', function(e){
            if (!menu.contains(e.target) && e.target !== downloadBtn) {
                menu.style.display = 'none';
            }
        });
    }

    // ---------- download selected (excel / pdf) ----------
    async function downloadSelected(format) {
        const checked = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'));
        if (checked.length === 0) { alert('Select rows first'); return; }

        const rows = checked.map(cb => {
            try { return JSON.parse(cb.dataset.row || "{}"); } catch(e) { return {}; }
        });

        const keys = Object.keys(rows[0] || {}).filter(k => k !== "_id");

        if (format === 'excel') {
            const jsonData = rows.map(r => {
                const obj = {};
                Object.keys(r).forEach(k => {
                    if (k === '_id') return;
                    obj[k] = formatCellValue(r[k]);
                });
                return obj;
            });
            const ws = XLSX.utils.json_to_sheet(jsonData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Selected");
            XLSX.writeFile(wb, "selected_rows.xlsx");
        } else if (format === 'pdf') {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF("l", "mm", "a4");
            // reuse your earlier robust pdf logic or a simplified table export here
            // Simplified approach: create small PDF listing rows as lines
            doc.setFontSize(10);
            let y = 10;
            rows.forEach((r, idx) => {
                const line = Object.entries(r).filter(([k])=> k !== '_id').map(([k,v]) => `${k}: ${formatCellValue(v)}`).join('  |  ');
                doc.text(`${idx+1}. ${line}`, 10, y);
                y += 6;
                if (y > doc.internal.pageSize.getHeight() - 10) { doc.addPage(); y = 10; }
            });
            doc.save('selected_rows.pdf');
        }
        // hide menu
        const menu = document.getElementById('download-menu'); if (menu) menu.style.display = 'none';
    }

    // ---------- download whole page as PDF ----------
    document.getElementById('downloadWholePDFBtn').addEventListener('click', function(){
        const element = document.body;
        window.scrollTo(0,0);

        // Use window.jspdf (UMD) export reliably, and robust multi-page handling
        html2canvas(element, { scale: 2, useCORS: true, allowTaint: true }).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const { jsPDF } = window.jspdf || window; // use UMD export
            const pdf = new jsPDF('p','mm','a4');
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();

            const imgWidth = pageWidth;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;

            let position = 0;
            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);

            let heightLeft = imgHeight - pageHeight;
            while (heightLeft > 0) {
                position = -heightLeft;
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
            }

            pdf.save('Coal_Blending_Ratio.pdf');
        }).catch(err => {
            console.error('PDF generation failed', err);
            alert('Failed to create PDF of page. Try resizing or use browser print to save as PDF.');
        });
    });

    // ---------- init ----------
    document.addEventListener('DOMContentLoaded', () => {
        setupDownloadDropdown();
        fetchData();
    });

    function logoutUser() { localStorage.setItem('isLoggedIn','false'); window.location.href='/login.html'; }
</script>
</body>

<!-- ====== START: COMMON NAVBAR (paste into each HTML file, right after <body>) ====== -->
<style>
/* Common navbar override (will replace previous styles visually) */
:root{
  --nav-h: 90px;
  --nav-bg-start: rgba(255,255,255,0.96);
  --nav-bg-end: rgba(245,247,255,0.88);
  --nav-blue-1: #02126e;
  --nav-blue-2: #0027a7;
  --nav-text: #071a52;
  --nav-btn-radius: 999px;
}

/* Strongly scoped to override older rules */
.common-navbar-wrapper { position: fixed; top: 0; left: 0; right: 0; height: var(--nav-h); z-index: 1300; }
.common-navbar {
  box-sizing: border-box;
  height: 100%;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 12px;
  padding: 8px 20px;
  background: linear-gradient(180deg, var(--nav-bg-start), var(--nav-bg-end));
  box-shadow: 0 8px 30px rgba(9,20,46,0.06);
  border-bottom: 1px solid rgba(2,18,110,0.04);
  backdrop-filter: blur(4px) saturate(1.02);
  font-family: Inter, Arial, Helvetica, sans-serif;
}

/* Left: logo + title */
.common-navbar .brand { display:flex; align-items:center; gap:12px; }
.common-navbar .brand img { height:46px; width:auto; object-fit:contain; display:block; }
.common-navbar .brand .title { font-weight:700; color:var(--nav-text); font-size:18px; margin:0; }

/* Center/right: nav buttons */
.common-navbar .nav-buttons { display:flex; gap:10px; align-items:center; margin-left:12px; }
.common-navbar .nav-buttons button{
  padding:8px 14px;
  border-radius:var(--nav-btn-radius);
  border: none;
  font-weight:600;
  cursor:pointer;
  background: linear-gradient(180deg,var(--nav-blue-1),var(--nav-blue-2));
  color: #fff;
  box-shadow: 0 8px 20px rgba(2,18,110,0.07);
  transition: transform .12s ease, box-shadow .12s ease, opacity .12s;
}
.common-navbar .nav-buttons button:hover{ transform: translateY(-2px); }
.common-navbar .nav-buttons button.logout-btn{
  background: linear-gradient(180deg,#ff4b4b,#e32d2d) !important;
  box-shadow: 0 8px 20px rgba(227,45,45,0.07);
}

/* Active page visual (different contrast + subtle outline) */
.common-navbar .nav-buttons button.active {
  background: linear-gradient(180deg,#ffffff, #f1f6ff) !important;
  color: var(--nav-blue-2) !important;
  box-shadow: 0 6px 18px rgba(2,18,110,0.06) !important;
  border: 1px solid rgba(2,18,110,0.12);
  transform: translateY(-1px) !important;
}

/* Mobile: make buttons smaller/wrapping */
@media (max-width: 720px) {
  .common-navbar { padding:10px 14px; }
  .common-navbar .brand .title { font-size:15px; }
  .common-navbar .nav-buttons { gap:6px; }
  .common-navbar .nav-buttons button { padding:7px 10px; font-size:13px; }
}

/* push page content below navbar (only added if page doesn't already do it) */
html body { --navbar-height: var(--nav-h); }
/* main, .content, .toolbar-wrapper, #content, #coalForm { margin-top: calc(var(--navbar-height) + 12px) !important; } */
</style>

<div class="common-navbar-wrapper" role="navigation" aria-label="Main navigation">
  <nav class="common-navbar">
    <div class="brand" aria-hidden="false">
      <img src="/images/abhitech-logo.png" alt="Abhitech logo">
      <h1 class="title">Combustion Analyzer</h1>
    </div>

    <div style="display:flex; align-items:center; gap:12px;">
      <div class="nav-buttons" role="menubar" aria-label="Primary">
        <!-- important: use the exact filenames from your site -->
        <button data-target="coal_table.html" title="Coal Properties">Coal Properties</button>
        <button data-target="slagging_coal_page.html" title="Calculation">Calculation</button>
        <button data-target="model.html" title="Model">Model</button>
      </div>

      <div style="width:8px;"></div>

      <!-- keep logout last -->
      <div class="nav-buttons" aria-hidden="false">
        <button class="logout-btn" id="common-logout-btn" title="Logout">Logout</button>
      </div>
    </div>
  </nav>
</div>

<script>
/* Common navbar script: sets active button and wiring
   Paste this JS as-is into each page (kept inline for simplicity).
*/
(function(){
  // find nav buttons and add click behavior
  const navBtns = Array.from(document.querySelectorAll('.common-navbar .nav-buttons button'))
    .filter(b => b.dataset && b.dataset.target); // keep element buttons only

  // mark active based on current path or filename
  const path = (location.pathname || '').split('/').pop().toLowerCase();

  let matched = false;
  navBtns.forEach(btn => {
    const target = (btn.dataset.target || '').toLowerCase();
    // button click navigates (keeps behavior same)
    btn.addEventListener('click', () => { if (target) location.href = target; });
    // choose active when filenames match, or if path is empty, match model.html as default
    if ((path && path === target) || (!path && target === 'model.html')) {
      btn.classList.add('active');
      matched = true;
    } else {
      btn.classList.remove('active');
    }
  });

  // If no match found (e.g. URL rewrite), try to match by presence of page-specific id in body
  if (!matched) {
    const pageHints = ['coal', 'slag', 'model'];
    for (const btn of navBtns) {
      const t = btn.dataset.target || '';
      for (const h of pageHints) {
        if (t.indexOf(h) !== -1 && document.body.innerText.toLowerCase().includes(h)) {
          btn.classList.add('active'); matched = true; break;
        }
      }
      if (matched) break;
    }
  }

  // logout behavior (matches earlier logout functions)
  const logoutBtn = document.getElementById('common-logout-btn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', () => {
      try { localStorage.setItem('isLoggedIn','false'); } catch(e) {}
      // preserve existing logout pattern: redirect to login.html
      window.location.href = '/login.html';
    });
  }
})();
</script>
<!-- ====== END: COMMON NAVBAR ====== -->

</html>
